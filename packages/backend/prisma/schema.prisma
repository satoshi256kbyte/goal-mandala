// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserIndustry {
  TECHNOLOGY
  FINANCE
  HEALTHCARE
  EDUCATION
  MANUFACTURING
  RETAIL
  CONSULTING
  GOVERNMENT
  NON_PROFIT
  OTHER
}

enum CompanySize {
  STARTUP // 1-10人
  SMALL // 11-50人
  MEDIUM // 51-200人
  LARGE // 201-1000人
  ENTERPRISE // 1000人以上
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

enum ActionType {
  EXECUTION // 実行アクション
  HABIT // 習慣アクション
}

enum TaskType {
  EXECUTION // 実行タスク
  HABIT // 習慣タスク
}

enum TaskStatus {
  NOT_STARTED // 未着手
  IN_PROGRESS // 進行中
  COMPLETED // 完了
  SKIPPED // スキップ
}

enum ReminderStatus {
  PENDING // 送信待ち
  SENT // 送信済み
  FAILED // 送信失敗
  CANCELLED // キャンセル
}

enum EmailStatus {
  SENT // 送信済み
  FAILED // 送信失敗
  BOUNCED // バウンス
}

enum MoodPreference {
  STAY_ON_TRACK // このまま行く
  CHANGE_PACE // 気分を変える
}

enum ProcessingType {
  SUBGOAL_GENERATION // サブ目標生成
  ACTION_GENERATION // アクション生成
  TASK_GENERATION // タスク生成
}

enum ProcessingStatus {
  PENDING // 待機中
  PROCESSING // 処理中
  COMPLETED // 完了
  FAILED // 失敗
  TIMEOUT // タイムアウト
  CANCELLED // キャンセル
}

enum WorkflowStatus {
  RUNNING // 実行中
  SUCCEEDED // 成功
  FAILED // 失敗
  TIMED_OUT // タイムアウト
  ABORTED // 中断
}

// Models
model User {
  id          String        @id @default(uuid()) @db.Uuid
  email       String        @unique @db.VarChar(255)
  name        String        @db.VarChar(100)
  industry    UserIndustry?
  companySize CompanySize?
  jobType     String?       @db.VarChar(100)
  position    String?       @db.VarChar(100)
  createdAt   DateTime      @default(now()) @db.Timestamptz
  updatedAt   DateTime      @updatedAt @db.Timestamptz

  // Relations
  goals           Goal[]
  changeHistory   ChangeHistory[]
  processingState ProcessingState[]

  @@map("users")
}

model Goal {
  id          String     @id @default(uuid()) @db.Uuid
  userId      String     @db.Uuid
  title       String     @db.VarChar(200)
  description String?    @db.Text
  deadline    DateTime?  @db.Timestamptz
  background  String?    @db.Text
  constraints String?    @db.Text
  status      GoalStatus @default(ACTIVE)
  progress    Int        @default(0) @db.SmallInt
  createdAt   DateTime   @default(now()) @db.Timestamptz
  updatedAt   DateTime   @updatedAt @db.Timestamptz

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subGoals    SubGoal[]
  reflections Reflection[]

  // Indexes
  @@index([userId, status])
  @@index([userId, createdAt])
  @@map("goals")
}

model SubGoal {
  id          String   @id @default(uuid()) @db.Uuid
  goalId      String   @db.Uuid
  title       String   @db.VarChar(200)
  description String?  @db.Text
  background  String?  @db.Text
  constraints String?  @db.Text
  position    Int      @db.SmallInt
  progress    Int      @default(0) @db.SmallInt
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  // Relations
  goal    Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  actions Action[]

  // Unique constraints
  @@unique([goalId, position])
  // Indexes
  @@index([goalId, position])
  @@map("sub_goals")
}

model Action {
  id          String     @id @default(uuid()) @db.Uuid
  subGoalId   String     @db.Uuid
  title       String     @db.VarChar(200)
  description String?    @db.Text
  background  String?    @db.Text
  constraints String?    @db.Text
  type        ActionType @default(EXECUTION)
  position    Int        @db.SmallInt
  progress    Int        @default(0) @db.SmallInt
  createdAt   DateTime   @default(now()) @db.Timestamptz
  updatedAt   DateTime   @updatedAt @db.Timestamptz

  // Relations
  subGoal SubGoal @relation(fields: [subGoalId], references: [id], onDelete: Cascade)
  tasks   Task[]

  // Unique constraints
  @@unique([subGoalId, position])
  // Indexes
  @@index([subGoalId, position])
  @@map("actions")
}

model Task {
  id               String     @id @default(uuid()) @db.Uuid
  actionId         String     @db.Uuid
  title            String     @db.VarChar(255)
  description      String?    @db.Text
  type             TaskType   @default(EXECUTION)
  status           TaskStatus @default(NOT_STARTED)
  estimatedMinutes Int        @db.SmallInt
  deadline         DateTime?  @db.Timestamptz
  completedAt      DateTime?  @db.Timestamptz
  createdAt        DateTime   @default(now()) @db.Timestamptz
  updatedAt        DateTime   @updatedAt @db.Timestamptz

  // Relations
  action          Action           @relation(fields: [actionId], references: [id], onDelete: Cascade)
  reminders       TaskReminder[]
  taskReflections TaskReflection[]
  notes           TaskNote[]
  history         TaskHistory[]

  // Indexes
  @@index([actionId, status])
  @@index([status])
  @@index([deadline])
  @@index([createdAt])
  @@map("tasks")
}

model TaskReminder {
  id         String         @id @default(uuid()) @db.Uuid
  taskId     String         @db.Uuid
  reminderAt DateTime       @db.Timestamptz
  message    String?        @db.Text
  status     ReminderStatus @default(PENDING)
  sentAt     DateTime?      @db.Timestamptz
  createdAt  DateTime       @default(now()) @db.Timestamptz
  updatedAt  DateTime       @updatedAt @db.Timestamptz

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([status, reminderAt])
  @@index([taskId, reminderAt])
  @@map("task_reminders")
}

model TaskReflection {
  id        String   @id @default(uuid()) @db.Uuid
  taskId    String   @db.Uuid
  content   String   @db.Text
  rating    Int?     @db.SmallInt
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([taskId, createdAt])
  @@map("task_reflections")
}

model Reflection {
  id                  String   @id @default(uuid()) @db.Uuid
  goalId              String   @db.Uuid
  summary             String   @db.Text
  regretfulActions    String?  @db.Text
  slowProgressActions String?  @db.Text
  untouchedActions    String?  @db.Text
  createdAt           DateTime @default(now()) @db.Timestamptz
  updatedAt           DateTime @updatedAt @db.Timestamptz

  // Relations
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([goalId, createdAt(sort: Desc)])
  @@map("reflections")
}

model ProgressHistory {
  id         String   @id @default(uuid()) @db.Uuid
  entityType String   @db.VarChar(20) // 'goal', 'subgoal', 'action', 'task'
  entityId   String   @db.Uuid
  progress   Int      @db.SmallInt // 0-100の進捗率
  timestamp  DateTime @default(now()) @db.Timestamptz
  createdAt  DateTime @default(now()) @db.Timestamptz

  // Indexes
  @@index([entityType, entityId, timestamp])
  @@index([timestamp])
  @@map("progress_history")
}

model ChangeHistory {
  id         String   @id @default(uuid()) @db.Uuid
  entityType String   @db.VarChar(20) // 'goal', 'subgoal', 'action'
  entityId   String   @db.Uuid
  userId     String   @db.Uuid
  changedAt  DateTime @default(now()) @db.Timestamptz
  changes    Json // 変更内容の配列: [{ field: string, oldValue: string, newValue: string }]
  createdAt  DateTime @default(now()) @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([entityType, entityId, changedAt])
  @@index([userId, changedAt])
  @@map("change_history")
}

model ProcessingState {
  id          String           @id @default(uuid()) @db.Uuid
  userId      String           @db.Uuid
  type        ProcessingType
  status      ProcessingStatus @default(PENDING)
  targetId    String?          @db.Uuid // goalId, subGoalId, actionId
  progress    Int              @default(0) @db.SmallInt
  result      Json? // 処理結果
  error       Json? // エラー情報
  retryCount  Int              @default(0) @db.SmallInt
  createdAt   DateTime         @default(now()) @db.Timestamptz
  updatedAt   DateTime         @updatedAt @db.Timestamptz
  completedAt DateTime?        @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([type, status])
  @@map("processing_state")
}

model TaskNote {
  id        String   @id @default(uuid()) @db.Uuid
  taskId    String   @db.Uuid
  userId    String   @db.Uuid
  content   String   @db.Text
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([taskId])
  @@index([createdAt])
  @@map("task_notes")
}

model TaskHistory {
  id        String     @id @default(uuid()) @db.Uuid
  taskId    String     @db.Uuid
  userId    String     @db.Uuid
  oldStatus TaskStatus
  newStatus TaskStatus
  changedAt DateTime   @default(now()) @db.Timestamptz

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([taskId])
  @@index([changedAt])
  @@map("task_history")
}

model SavedView {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  name        String   @db.VarChar(255)
  filters     Json // TaskFilters型のJSON
  searchQuery String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  // Indexes
  @@index([userId])
  @@index([createdAt])
  @@map("saved_views")
}

model ReminderLog {
  id           String      @id @default(uuid()) @db.Uuid
  userId       String      @db.Uuid
  sentAt       DateTime    @db.Timestamptz
  taskIds      String[]    @db.Uuid
  emailStatus  EmailStatus
  messageId    String?     @db.VarChar(255)
  errorMessage String?     @db.Text
  retryCount   Int         @default(0) @db.SmallInt
  createdAt    DateTime    @default(now()) @db.Timestamptz
  updatedAt    DateTime    @updatedAt @db.Timestamptz

  // Indexes
  @@index([userId, sentAt])
  @@index([emailStatus])
  @@index([sentAt])
  @@map("reminder_logs")
}

model UserReminderPreference {
  userId             String          @id @db.Uuid
  enabled            Boolean         @default(true)
  moodPreference     MoodPreference?
  lastReminderSentAt DateTime?       @db.Timestamptz
  unsubscribedAt     DateTime?       @db.Timestamptz
  createdAt          DateTime        @default(now()) @db.Timestamptz
  updatedAt          DateTime        @updatedAt @db.Timestamptz

  // Indexes
  @@index([enabled])
  @@index([lastReminderSentAt])
  @@map("user_reminder_preferences")
}

model HabitTaskReminderTracking {
  id             String   @id @default(uuid()) @db.Uuid
  taskId         String   @db.Uuid
  lastRemindedAt DateTime @db.Timestamptz
  reminderCount  Int      @default(0) @db.SmallInt
  weekNumber     Int      @db.SmallInt // ISO week number
  createdAt      DateTime @default(now()) @db.Timestamptz
  updatedAt      DateTime @updatedAt @db.Timestamptz

  // Indexes
  @@index([taskId])
  @@index([lastRemindedAt])
  @@index([weekNumber])
  @@map("habit_task_reminder_tracking")
}

model WorkflowExecution {
  id                     String         @id @default(uuid()) @db.Uuid
  executionArn           String         @unique @db.VarChar(500)
  goalId                 String         @db.Uuid
  userId                 String         @db.Uuid
  status                 WorkflowStatus @default(RUNNING)
  startDate              DateTime       @db.Timestamptz
  stopDate               DateTime?      @db.Timestamptz
  input                  Json // { goalId: string, actionIds: string[] }
  output                 Json? // { successCount: number, failedCount: number, failedActions: string[] }
  progressPercentage     Int            @default(0) @db.SmallInt
  processedActions       Int            @default(0) @db.SmallInt
  totalActions           Int            @db.SmallInt
  currentBatch           Int            @default(0) @db.SmallInt
  totalBatches           Int            @db.SmallInt
  estimatedTimeRemaining Int            @default(0) @db.Integer // 秒単位
  ttl                    Int? // Unix timestamp for TTL (90 days)
  createdAt              DateTime       @default(now()) @db.Timestamptz
  updatedAt              DateTime       @updatedAt @db.Timestamptz

  // Indexes
  @@index([goalId, createdAt])
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([ttl])
  @@map("workflow_executions")
}
