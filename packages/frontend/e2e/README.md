# E2Eテスト

このディレクトリには、認証画面のE2E（End-to-End）テストが含まれています。

## テスト構成

### テストファイル

- `auth/login.spec.ts` - ログインフローのE2Eテスト
- `auth/signup.spec.ts` - サインアップフローのE2Eテスト
- `auth/password-reset.spec.ts` - パスワードリセットフローのE2Eテスト
- `auth/error-cases.spec.ts` - エラーケースのテスト
- `auth/auth-integration.spec.ts` - 認証フロー全体の統合テスト

### ヘルパーファイル

- `helpers/auth-helpers.ts` - 認証関連のヘルパー関数
- `mocks/auth-mocks.ts` - 認証APIのモック設定
- `fixtures/test-data.ts` - テストデータとメッセージ定義

## テスト実行

### 基本的な実行

```bash
# 全てのE2Eテストを実行
pnpm test:e2e

# 特定のブラウザでテスト実行
pnpm test:e2e --project=chromium
pnpm test:e2e --project=firefox
pnpm test:e2e --project=webkit

# 特定のテストファイルを実行
pnpm test:e2e auth/login.spec.ts
```

### デバッグ実行

```bash
# UIモードでテスト実行
pnpm test:e2e:ui

# ヘッドモードでテスト実行（ブラウザが表示される）
pnpm test:e2e:headed

# デバッグモードでテスト実行
pnpm test:e2e:debug
```

### モバイルテスト

```bash
# モバイルデバイスでテスト実行
pnpm test:e2e --project="Mobile Chrome"
pnpm test:e2e --project="Mobile Safari"
```

## テスト対象機能

### ログインフロー

- 正常なログイン
- 無効な認証情報でのログイン失敗
- 未確認ユーザーのログイン
- バリデーションエラー
- ページ遷移
- キーボードナビゲーション

### サインアップフロー

- 正常なサインアップ
- 既存ユーザーでのサインアップ失敗
- バリデーションエラー
- パスワード強度インジケーター
- リアルタイムバリデーション
- フォーム入力の永続化

### パスワードリセットフロー

- 正常なパスワードリセット
- 未登録メールアドレスでのリセット
- バリデーションエラー
- 複数回送信の制御
- メール送信後の案内表示

### エラーケース

- ネットワークエラー
- サーバーエラー
- Cognitoエラー
- タイムアウトエラー
- セッション管理エラー
- ブラウザ互換性エラー
- アクセシビリティエラー

### 統合テスト

- サインアップ→ログインフロー
- ログイン→ログアウト→再ログインフロー
- パスワードリセット→新しいパスワードでログインフロー
- 認証が必要なページへの直接アクセス
- セッション期限切れ後の自動ログアウト
- 複数タブでの認証状態同期
- ブラウザ戻る/進むボタンでの認証フロー
- レスポンシブデザインでの認証フロー

## モック設定

### 認証API

テストでは実際のCognitoではなく、モックAPIを使用します：

- **成功レスポンス**: 有効なテストユーザーでの認証
- **エラーレスポンス**: 各種Cognitoエラーのシミュレーション
- **ネットワークエラー**: 接続失敗のシミュレーション

### テストデータ

`fixtures/test-data.ts`で定義されたテストユーザー：

- `validUser`: 正常なテスト用ユーザー
- `invalidUser`: バリデーションエラー用ユーザー
- `existingUser`: 既存ユーザーエラー用ユーザー
- `unconfirmedUser`: 未確認ユーザーエラー用ユーザー

## CI/CD統合

GitHub Actionsで自動実行されます：

- **トリガー**: main/developブランチへのpush、PRの作成
- **ブラウザ**: Chromium、Firefox、Webkit
- **成果物**: テストレポート、失敗時のスクリーンショット・動画

## ベストプラクティス

### テスト作成時の注意点

1. **data-testid属性の使用**: セレクターには`data-testid`属性を使用
2. **明示的な待機**: `expect`を使用した状態確認
3. **独立性**: 各テストは独立して実行可能
4. **クリーンアップ**: テスト後の状態クリーンアップ
5. **エラーハンドリング**: 予期しないエラーの適切な処理

### パフォーマンス最適化

1. **並列実行**: 関連性のないテストは並列実行
2. **モック使用**: 外部APIはモックを使用
3. **リソース管理**: 不要なリソースの適切な解放
4. **タイムアウト設定**: 適切なタイムアウト値の設定

## トラブルシューティング

### よくある問題

1. **タイムアウトエラー**: 待機時間の調整
2. **セレクターエラー**: data-testid属性の確認
3. **モックエラー**: モック設定の確認
4. **ブラウザ固有の問題**: 特定ブラウザでのテスト実行

### デバッグ方法

1. **スクリーンショット**: 失敗時の画面確認
2. **動画録画**: テスト実行の全体確認
3. **ログ出力**: コンソールログの確認
4. **ステップ実行**: デバッグモードでの段階的実行
