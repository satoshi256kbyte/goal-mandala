# 振り返り機能 要件定義

## Introduction

振り返り機能は、ユーザーが目標達成状況を定期的に振り返り、改善点を記録するための機能です。ユーザーは任意のタイミングで振り返りを作成し、過去の振り返りを参照できます。

## Glossary

- **Reflection（振り返り）**: 目標達成状況の分析と改善点の記録
- **Goal（目標）**: ユーザーが達成したい具体的な成果物や状態
- **Action（アクション）**: サブ目標達成に必要な具体的行動
- **Summary（総括）**: 目標達成状況の全体的な振り返り
- **Regretful Actions（惜しかったアクション）**: もう少しで達成できそうだったアクション
- **Slow Progress Actions（進まなかったアクション）**: 思ったより進捗しなかったアクション
- **Untouched Actions（未着手アクション）**: 全く手をつけられなかったアクション

## Requirements

### Requirement 1

**User Story:** ユーザーとして、目標の振り返りを作成したい。そうすることで、目標達成状況を記録し、改善点を明確にできる。

#### Acceptance Criteria

1. WHEN ユーザーが振り返り画面にアクセスする THEN システムは目標の進捗データを取得して表示する
2. WHEN ユーザーが振り返り内容を入力する THEN システムは総括、惜しかったアクション、進まなかったアクション、未着手アクションの入力を受け付ける
3. WHEN ユーザーが振り返りを保存する THEN システムは振り返りをデータベースに保存し、完了画面を表示する
4. WHEN 総括が空の場合 THEN システムはバリデーションエラーを表示する
5. WHEN 振り返り保存に失敗した場合 THEN システムはエラーメッセージを表示し、入力内容を保持する

### Requirement 2

**User Story:** ユーザーとして、過去の振り返りを閲覧したい。そうすることで、目標達成の経緯を振り返り、今後の改善に活かせる。

#### Acceptance Criteria

1. WHEN ユーザーが振り返り履歴画面にアクセスする THEN システムは目標に紐づく振り返りを作成日時の降順で表示する
2. WHEN 振り返りが存在しない場合 THEN システムは「振り返りがありません」というメッセージを表示する
3. WHEN ユーザーが振り返りを選択する THEN システムは振り返りの詳細を表示する
4. WHEN 振り返り一覧の取得に失敗した場合 THEN システムはエラーメッセージを表示する

### Requirement 3

**User Story:** ユーザーとして、過去の振り返りを編集したい。そうすることで、振り返り内容を修正・追記できる。

#### Acceptance Criteria

1. WHEN ユーザーが振り返り詳細画面で編集ボタンをクリックする THEN システムは振り返り編集画面を表示する
2. WHEN ユーザーが振り返り内容を編集する THEN システムは変更内容を受け付ける
3. WHEN ユーザーが更新を保存する THEN システムは振り返りを更新し、詳細画面に戻る
4. WHEN 総括が空の場合 THEN システムはバリデーションエラーを表示する
5. WHEN 振り返り更新に失敗した場合 THEN システムはエラーメッセージを表示し、入力内容を保持する

### Requirement 4

**User Story:** ユーザーとして、不要な振り返りを削除したい。そうすることで、振り返り履歴を整理できる。

#### Acceptance Criteria

1. WHEN ユーザーが振り返り詳細画面で削除ボタンをクリックする THEN システムは削除確認ダイアログを表示する
2. WHEN ユーザーが削除を確認する THEN システムは振り返りを削除し、振り返り履歴画面に戻る
3. WHEN ユーザーが削除をキャンセルする THEN システムは削除を中止し、詳細画面に留まる
4. WHEN 振り返り削除に失敗した場合 THEN システムはエラーメッセージを表示する

### Requirement 5

**User Story:** ユーザーとして、振り返り入力時にアクションの進捗状況を参照したい。そうすることで、正確な振り返りを記録できる。

#### Acceptance Criteria

1. WHEN ユーザーが振り返り画面にアクセスする THEN システムは目標に紐づく全アクションの進捗状況を表示する
2. WHEN アクションの進捗が80%以上の場合 THEN システムはそのアクションを「惜しかったアクション」の候補として表示する
3. WHEN アクションの進捗が20%以下の場合 THEN システムはそのアクションを「進まなかったアクション」の候補として表示する
4. WHEN アクションの進捗が0%の場合 THEN システムはそのアクションを「未着手アクション」の候補として表示する
5. WHEN ユーザーが候補からアクションを選択する THEN システムは選択されたアクションを該当フィールドに追加する

### Requirement 6

**User Story:** システム管理者として、振り返りデータの整合性を保証したい。そうすることで、データの信頼性を確保できる。

#### Acceptance Criteria

1. WHEN 振り返りが作成される THEN システムは振り返りが有効な目標に紐づいていることを検証する
2. WHEN 目標が削除される THEN システムは紐づく振り返りも削除する（CASCADE）
3. WHEN 振り返りが作成される THEN システムは作成日時と更新日時を自動的に設定する
4. WHEN 振り返りが更新される THEN システムは更新日時を自動的に更新する
5. WHEN 振り返りが取得される THEN システムは作成日時の降順でソートする
