# 要件定義書

## はじめに

この要件定義書は、サブ目標から8つのアクションを自動生成するAPIの実装について定義します。2.2.1で実装したBedrock Lambda関数と2.2.2で実装したサブ目標生成APIを基盤として、マンダラチャート作成の第2ステップとなるアクション生成機能を提供します。

## 要件

### 要件1: アクション生成エンドポイント

**ユーザーストーリー:** ユーザーとして、サブ目標情報を入力してアクションを自動生成したい。そうすることで、サブ目標達成のための具体的な行動計画を素早く把握できる。

#### 受入基準

1. WHEN POST /api/ai/generate/actions エンドポイントにリクエストを送信する THEN アクション生成処理が開始される
2. WHEN リクエストボディにサブ目標情報が含まれる THEN 必須フィールド（subGoalId、title、description、background）が検証される
3. WHEN 認証トークンが有効である THEN ユーザーIDが抽出され、リクエストに紐付けられる
4. WHEN アクション生成が成功する THEN 8個のアクションがデータベースに保存される
5. WHEN レスポンスを返す THEN 生成されたアクションの配列とメタデータが返される
6. WHEN エラーが発生する THEN 適切なHTTPステータスコードとエラーメッセージが返される
7. WHEN 目標コンテキストが利用可能である THEN 目標情報もプロンプトに含まれる

### 要件2: サブ目標コンテキスト活用

**ユーザーストーリー:** システム開発者として、サブ目標だけでなく目標全体のコンテキストを活用したい。そうすることで、より一貫性のあるアクションを生成できる。

#### 受入基準

1. WHEN アクション生成リクエストを処理する THEN サブ目標の親目標情報がデータベースから取得される
2. WHEN プロンプトを構築する THEN 目標のタイトル、説明、期限、背景が含まれる
3. WHEN プロンプトを構築する THEN サブ目標のタイトル、説明、背景が含まれる
4. WHEN 他のサブ目標が存在する THEN 関連サブ目標の情報も参考情報として含まれる
5. WHEN ユーザー情報が利用可能である THEN 業種・職種情報がコンテキストとして含まれる

### 要件3: アクション種別判定機能

**ユーザーストーリー:** ユーザーとして、アクションが「実行アクション」か「習慣アクション」かを自動判定してほしい。そうすることで、適切なタスク管理とリマインド設定が可能になる。

#### 受入基準

1. WHEN アクションを生成する THEN 各アクションに種別（EXECUTION/HABIT）が設定される
2. WHEN アクションが一度で完了する性質である THEN 種別がEXECUTIONに設定される
3. WHEN アクションが継続的な実施が必要である THEN 種別がHABITに設定される
4. WHEN AIが種別を判定する THEN プロンプトに判定基準が明示される
5. WHEN 種別が不明確である THEN デフォルトでEXECUTIONが設定される
6. WHEN ユーザーが種別を変更する THEN 後から編集可能である

### 要件4: 重複排除機能

**ユーザーストーリー:** システム開発者として、生成されたアクション間の重複を検出したい。そうすることで、無駄のない効率的なアクションリストを提供できる。

#### 受入基準

1. WHEN アクションを生成する THEN 同一サブ目標内でタイトルの重複がチェックされる
2. WHEN タイトルが類似している THEN 警告ログが記録される
3. WHEN 説明が酷似している THEN 警告ログが記録される
4. WHEN 重複が検出される THEN 品質スコアが低下する
5. WHEN 重複が多い THEN 再生成が推奨される

### 要件5: 品質フィルタリング

**ユーザーストーリー:** システム開発者として、生成されたアクションの品質を評価したい。そうすることで、低品質な結果を検出し、再生成を促すことができる。

#### 受入基準

1. WHEN アクションが生成される THEN 8個のアクションが生成されていることが検証される
2. WHEN アクションが生成される THEN 各アクションのタイトルが50文字以内であることが検証される
3. WHEN アクションが生成される THEN 各アクションの説明が100文字以上200文字以内であることが検証される
4. WHEN アクションが生成される THEN 各アクションの背景が100文字以内であることが検証される
5. WHEN アクションの説明が不十分である（50文字未満） THEN 警告ログが記録される
6. WHEN アクションが抽象的すぎる THEN 警告ログが記録される
7. WHEN 品質基準を満たさない THEN エラーレスポンスが返され、再試行が促される

### 要件6: データベース統合

**ユーザーストーリー:** システム開発者として、生成されたアクションをデータベースに永続化したい。そうすることで、ユーザーが後から確認・編集できる。

#### 受入基準

1. WHEN アクション生成が成功する THEN SubGoalレコードが更新される
2. WHEN アクションを保存する THEN 8個のActionレコードがトランザクション内で作成される
3. WHEN データベースエラーが発生する THEN トランザクションがロールバックされる
4. WHEN アクションを保存する THEN subGoalIdとの外部キー関係が正しく設定される
5. WHEN アクションを保存する THEN position（0-7）がユニーク制約を満たす
6. WHEN アクションを保存する THEN type（EXECUTION/HABIT）が正しく設定される
7. WHEN 既存のアクションが存在する THEN 既存データを削除してから新規作成される

### 要件7: エラーハンドリングと再試行

**ユーザーストーリー:** ユーザーとして、AI生成が失敗した場合に適切なフィードバックを受け取りたい。そうすることで、問題を理解し、適切に対処できる。

#### 受入基準

1. WHEN Bedrock APIがスロットリングエラーを返す THEN 自動的にリトライが実行される
2. WHEN リトライが3回失敗する THEN ユーザーフレンドリーなエラーメッセージが返される
3. WHEN JSON解析エラーが発生する THEN 「AI生成結果の解析に失敗しました」というメッセージが返される
4. WHEN データベースエラーが発生する THEN 「データの保存に失敗しました」というメッセージが返される
5. WHEN タイムアウトが発生する THEN 「処理時間が長すぎます。もう一度お試しください」というメッセージが返される
6. WHEN エラーが発生する THEN エラー詳細がCloudWatch Logsに記録される
7. WHEN エラーが発生する THEN ユーザーには機密情報を含まないエラーメッセージが返される

### 要件8: パフォーマンスとコスト管理

**ユーザーストーリー:** システム管理者として、API呼び出しのパフォーマンスとコストを管理したい。そうすることで、予算内で安定したサービスを提供できる。

#### 受入基準

1. WHEN アクション生成リクエストを処理する THEN 95パーセンタイルで30秒以内に完了する
2. WHEN 同時リクエストが発生する THEN Lambda同時実行数制限（10）が適用される
3. WHEN トークン使用量を記録する THEN CloudWatchカスタムメトリクスに送信される
4. WHEN 推定コストを計算する THEN ログに記録される
5. WHEN 月次コスト上限に近づく THEN アラートが発行される
6. WHEN プロンプトを最適化する THEN 不要なトークンが削減される

### 要件9: セキュリティとアクセス制御

**ユーザーストーリー:** システム管理者として、APIへの不正アクセスを防止したい。そうすることで、システムとユーザーデータを保護できる。

#### 受入基準

1. WHEN APIリクエストを受信する THEN JWT認証トークンが検証される
2. WHEN 認証トークンが無効である THEN 401 Unauthorizedが返される
3. WHEN ユーザーが他人のサブ目標を操作しようとする THEN 403 Forbiddenが返される
4. WHEN レート制限を超える THEN 429 Too Many Requestsが返される
5. WHEN プロンプトインジェクションを検出する THEN リクエストが拒否される
6. WHEN 機密情報をログに記録する THEN マスキングが適用される

### 要件10: 監視とログ

**ユーザーストーリー:** システム管理者として、API呼び出しの状況を監視したい。そうすることで、問題を早期に発見し、対処できる。

#### 受入基準

1. WHEN APIリクエストを処理する THEN 構造化ログがCloudWatch Logsに出力される
2. WHEN ログを出力する THEN requestId、userId、subGoalId、処理時間が含まれる
3. WHEN アクション生成が成功する THEN 成功メトリクスがCloudWatchに送信される
4. WHEN アクション生成が失敗する THEN 失敗メトリクスとエラー種別がCloudWatchに送信される
5. WHEN 処理時間が閾値を超える THEN アラートが発行される
6. WHEN エラー率が閾値を超える THEN アラートが発行される

## 非機能要件

### パフォーマンス

- API応答時間: 95パーセンタイルで30秒以内
- スループット: 10リクエスト/秒（初期設定）
- データベース接続: 接続プール使用

### 可用性

- API成功率: 99%以上
- 自動リトライによる復旧
- エラー時の適切なフォールバック

### スケーラビリティ

- Lambda同時実行数: 10（初期）→ 100（段階的拡張）
- データベース接続数: 適切な接続プール設定

### セキュリティ

- JWT認証必須
- プロンプトインジェクション対策
- レート制限: 10リクエスト/分/ユーザー
- 入力サニタイゼーション

### 監視

- CloudWatch Logsへの構造化ログ出力
- CloudWatch Metricsへのカスタムメトリクス送信
- エラー率、レスポンス時間、コストの監視
- アラート設定（エラー率、レスポンス時間）

## 制約事項

- Amazon Bedrock Nova Microモデルの利用制限に準拠
- Lambda関数の実行時間制限（最大15分）
- データベース接続数の制限
- 月次コスト予算の制約
- 1つのサブ目標に対して必ず8個のアクションを生成

## 依存関係

- 2.2.1 Bedrock Lambda関数（完了済み）
- 2.2.2 サブ目標生成API（完了済み）
- 1.4.2 Prismaスキーマ定義（完了済み）
- 1.3.2 JWT認証ミドルウェア（完了済み）
- AWS SDK for JavaScript v3
- Prismaクライアント
- Zodバリデーションライブラリ

## 成功基準

1. アクション生成APIが正常に動作する
2. 全ての受入基準を満たす
3. ユニットテストカバレッジが80%以上
4. 統合テストが全て成功する
5. パフォーマンス要件を満たす
6. セキュリティ要件を満たす
7. ドキュメントが整備される
8. フロントエンドとの統合が完了する

## インターフェース定義

### リクエスト形式

```typescript
POST /api/ai/generate/actions
Content-Type: application/json
Authorization: Bearer <JWT_TOKEN>

{
  "subGoalId": "uuid", // サブ目標ID（必須）
  "regenerate": false  // 既存のアクションを再生成する場合true（オプション）
}
```

### レスポンス形式（成功）

```typescript
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "data": {
    "subGoalId": "uuid",
    "actions": [
      {
        "id": "uuid",
        "title": "TypeScript公式ドキュメントを読む",
        "description": "TypeScript公式ドキュメントの基礎編を1日1章ずつ読み進め、サンプルコードを実際に動かして理解を深める",
        "background": "公式ドキュメントは最も正確で体系的な情報源であり、基礎を固めるために不可欠である",
        "type": "EXECUTION",
        "position": 0,
        "progress": 0,
        "createdAt": "2025-10-08T10:00:00Z",
        "updatedAt": "2025-10-08T10:00:00Z"
      },
      {
        "id": "uuid",
        "title": "毎日TypeScriptコードを書く",
        "description": "毎日最低30分はTypeScriptでコードを書き、型システムの理解を深める習慣を作る",
        "background": "継続的な実践により、TypeScriptの型システムが自然に身につく",
        "type": "HABIT",
        "position": 1,
        "progress": 0,
        "createdAt": "2025-10-08T10:00:00Z",
        "updatedAt": "2025-10-08T10:00:00Z"
      },
      // ... 残り6個のアクション
    ]
  },
  "metadata": {
    "generatedAt": "2025-10-08T10:00:00Z",
    "tokensUsed": 2000,
    "estimatedCost": 0.0003,
    "goalContext": {
      "goalTitle": "TypeScriptのエキスパートになる",
      "subGoalTitle": "TypeScriptの基礎文法を習得する"
    }
  }
}
```

### レスポンス形式（エラー）

```typescript
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力データが不正です",
    "details": [
      {
        "field": "subGoalId",
        "message": "サブ目標IDは必須です"
      }
    ]
  }
}
```

```typescript
HTTP/1.1 404 Not Found
Content-Type: application/json

{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "指定されたサブ目標が見つかりません"
  }
}
```

```typescript
HTTP/1.1 403 Forbidden
Content-Type: application/json

{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "このサブ目標にアクセスする権限がありません"
  }
}
```
