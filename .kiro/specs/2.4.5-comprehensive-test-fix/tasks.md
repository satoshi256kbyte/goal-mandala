# 実装タスクリスト

## 概要

本タスクリストは、包括的テスト修正機能の実装手順を定義します。テスト成功率を43.4%から95%以上に改善し、全173件の失敗テストを修正します。

## タスク一覧

- [x] 1. テスト実行環境の安定化
  - タイムアウト設定の追加とテスト設定ファイルの最適化
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 1.1 Vitest設定ファイルの最適化
  - `vitest.config.ts`にタイムアウト設定を追加（testTimeout: 30000ms）
  - 並列実行設定を追加（maxThreads: 4, minThreads: 1）
  - カバレッジ設定を追加（thresholds: 80%）
  - レポーター設定を追加（default, html, junit）
  - _要件: 1.1, 1.2, 1.5_

- [x] 1.2 テストセットアップファイルの作成
  - `src/test/setup.ts`を作成
  - グローバルモックの初期化（fetch, localStorage, sessionStorage）
  - テスト環境変数の設定
  - タイムアウトハンドラーの設定
  - _要件: 1.1, 1.2_

- [x] 1.3 Test Data Generatorの実装
  - `src/test/utils/TestDataGenerator.ts`を作成
  - `generateUser()`メソッドの実装
  - `generateGoal()`メソッドの実装
  - `generateSubGoals()`メソッドの実装（8個生成）
  - `generateActions()`メソッドの実装（64個生成）
  - `generateTasks()`メソッドの実装
  - _要件: 3.4_

- [x] 1.4 Mock Managerの実装
  - `src/test/utils/MockManager.ts`を作成
  - `mockAPI()`メソッドの実装
  - `mockReactQuery()`メソッドの実装
  - `mockRouter()`メソッドの実装
  - `mockAuth()`メソッドの実装
  - `resetAllMocks()`メソッドの実装
  - _要件: 3.5_

- [x] 1.5 Test Loggerの実装
  - `src/test/utils/TestLogger.ts`を作成
  - `logTestStart()`メソッドの実装
  - `logTestEnd()`メソッドの実装
  - `logError()`メソッドの実装
  - リアルタイム進捗表示機能の実装
  - _要件: 1.4_

- [-] 2. 進捗計算エンジンテストの修正（27件）
  - 進捗計算ロジックのテストを修正して全テストを成功させる
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_

- [x] 2.1 TaskProgressCalculatorのテスト修正
  - `src/services/__tests__/progress/TaskProgressCalculator.test.ts`を修正
  - 完了タスクの進捗計算テストを修正
  - 未完了タスクの進捗計算テストを修正
  - 部分完了タスクの進捗計算テストを修正
  - エッジケース（空配列、null、undefined）のテストを追加
  - テストデータをTestDataGeneratorから取得するように変更
  - _要件: 2.1_

- [x] 2.2 ExecutionActionCalculatorのテスト修正
  - `src/services/__tests__/progress/ExecutionActionCalculator.test.ts`を修正
  - 実行アクションの進捗計算テストを修正
  - タスク完了率に基づく進捗計算テストを修正
  - 全タスク完了時の進捗100%テストを修正
  - エッジケースのテストを追加
  - _要件: 2.2_

- [x] 2.3 HabitActionCalculatorのテスト修正
  - `src/services/__tests__/progress/HabitActionCalculator.test.ts`を修正
  - 習慣アクションの進捗計算テストを修正
  - 継続率に基づく進捗計算テストを修正
  - 80%継続で達成とみなすテストを修正
  - エッジケースのテストを追加
  - _要件: 2.3_

- [x] 2.4 SubGoalProgressCalculatorのテスト修正
  - `src/services/__tests__/progress/SubGoalProgressCalculator.test.ts`を修正
  - サブ目標の進捗計算テストを修正
  - アクション進捗の平均計算テストを修正
  - 全アクション完了時の進捗100%テストを修正
  - エッジケースのテストを追加
  - _要件: 2.4_

- [x] 2.5 GoalProgressCalculatorのテスト修正
  - `src/services/__tests__/progress/GoalProgressCalculator.test.ts`を修正
  - 目標の進捗計算テストを修正
  - サブ目標進捗の平均計算テストを修正
  - 全サブ目標完了時の進捗100%テストを修正
  - エッジケースのテストを追加
  - _要件: 2.5_

- [x] 2.6 ProgressValidatorのテスト修正
  - `src/services/__tests__/progress/ProgressValidator.test.ts`を修正
  - 進捗値の範囲検証テストを修正（0-100%）
  - 無効な進捗値のエラーハンドリングテストを修正
  - 境界値テストを追加（0%, 100%, -1%, 101%）
  - _要件: 2.6_

- [x] 2.7 ErrorHandlerのテスト修正
  - `src/services/__tests__/progress/ErrorHandler.test.ts`を修正
  - エラーハンドリングのテストを修正
  - エラーメッセージの検証テストを修正
  - エラーログの記録テストを修正
  - リトライロジックのテストを追加
  - _要件: 2.6_

- [x] 3. 統合テストの修正（49件）
  - コンポーネント間の統合テストを修正して全テストを成功させる
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 3.1 ProfileSetup統合テストの修正
  - `src/__tests__/integration/ProfileSetup.integration.test.tsx`を修正
  - テストデータのセットアップを改善（TestDataGenerator使用）
  - モック・スタブを統一（MockManager使用）
  - 非同期処理の待機を追加（waitFor, findBy使用）
  - プロフィール設定フローの正常動作テストを修正
  - バリデーションエラーのテストを修正
  - API エラーハンドリングのテストを修正
  - _要件: 3.1, 3.4, 3.5_

- [x] 3.2 history-flow統合テストの修正
  - `src/__tests__/integration/history-flow.integration.test.tsx`を修正
  - テストデータのセットアップを改善
  - モック・スタブを統一
  - 非同期処理の待機を追加
  - 履歴管理フローの正常動作テストを修正
  - 履歴表示のテストを修正
  - 履歴フィルタリングのテストを修正
  - _要件: 3.2, 3.4, 3.5_

- [x] 3.3 MandalaList統合テストの修正
  - `src/__tests__/integration/MandalaList.integration.test.tsx`を修正
  - テストデータのセットアップを改善
  - モック・スタブを統一
  - 非同期処理の待機を追加
  - マンダラ一覧表示フローの正常動作テストを修正
  - 検索・フィルター機能のテストを修正
  - ページネーション機能のテストを修正
  - ソート機能のテストを修正
  - _要件: 3.3, 3.4, 3.5_

- [x] 3.4 統合テスト共通ユーティリティの作成
  - `src/test/utils/integration-test-utils.ts`を作成
  - `setupIntegrationTest()`関数の実装（テストデータセットアップ）
  - `cleanupIntegrationTest()`関数の実装（テストデータクリーンアップ）
  - `waitForLoadingToFinish()`関数の実装
  - `mockAPIResponses()`関数の実装
  - _要件: 3.4, 3.5_

- [x] 4. アクセシビリティテストの修正（40件）
  - WCAG 2.1 AA基準を満たすようにテストを修正
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 4.1 accessibility-comprehensive.test.tsxの修正
  - `src/__tests__/accessibility-comprehensive.test.tsx`を修正
  - 全コンポーネントのアクセシビリティテストを修正
  - `jest-axe`による自動検証を追加
  - WCAG 2.1 AA基準の検証を追加
  - カラーコントラスト比のテストを追加
  - _要件: 4.1, 4.3_

- [x] 4.2 accessibility-utils.test.tsの修正
  - `src/__tests__/accessibility-utils.test.ts`を修正
  - アクセシビリティユーティリティ関数のテストを修正
  - `getAccessibleName()`関数のテストを修正
  - `hasAccessibleDescription()`関数のテストを修正
  - `isKeyboardAccessible()`関数のテストを修正
  - _要件: 4.2_

- [x] 4.3 ARIAラベルの追加と検証
  - 全インタラクティブ要素にARIAラベルを追加
  - ボタン、リンク、フォーム要素に`aria-label`または`aria-labelledby`を追加
  - モーダル、ダイアログに`role`、`aria-modal`、`aria-labelledby`を追加
  - ナビゲーション要素に`role="navigation"`、`aria-label`を追加
  - ARIAラベルの検証テストを追加
  - _要件: 4.3_

- [x] 4.4 キーボードナビゲーションの実装とテスト
  - 全インタラクティブ要素にキーボードイベントハンドラーを追加
  - Tab キーによるフォーカス移動のテストを追加
  - Enter/Space キーによる実行のテストを追加
  - Escape キーによるモーダル閉じるのテストを追加
  - 矢印キーによるナビゲーションのテストを追加
  - _要件: 4.4_

- [x] 4.5 スクリーンリーダー対応の強化とテスト
  - 全コンテンツに適切な`role`属性を追加
  - 動的コンテンツに`aria-live`、`aria-atomic`を追加
  - フォームエラーに`aria-invalid`、`aria-describedby`を追加
  - スクリーンリーダーテストを追加（`screen.getByRole`使用）
  - _要件: 4.5_

- [x] 5. アニメーション・コンポーネントテストの修正（57件）
  - アニメーションとコンポーネントのテストを修正
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 5.1 animation-functionality.test.tsxの修正
  - `src/__tests__/animation-functionality.test.tsx`を修正
  - `vi.useFakeTimers()`を使用してタイマーをモック
  - `act()`を使用して状態更新を同期
  - `vi.advanceTimersByTime()`でアニメーション完了を待機
  - アニメーション開始・完了のテストを修正
  - アニメーションキャンセルのテストを修正
  - _要件: 5.1_

- [x] 5.2 animation-performance.test.tsxの修正
  - `src/__tests__/animation-performance.test.tsx`を修正
  - アニメーションのパフォーマンステストを修正
  - フレームレート（60fps）のテストを修正
  - メモリ使用量のテストを修正
  - CPU使用率のテストを修正
  - _要件: 5.2_

- [x] 5.3 EditModal.test.tsxの修正
  - `src/components/__tests__/EditModal.test.tsx`を修正
  - モーダル表示・非表示のテストを修正
  - フォーム送信のテストを修正
  - バリデーションエラーのテストを修正
  - キーボード操作（Escape キー）のテストを修正
  - フォーカストラップのテストを修正
  - _要件: 5.3_

- [x] 5.4 SubGoalEditPage.test.tsxの修正
  - `src/pages/__tests__/SubGoalEditPage.test.tsx`を修正
  - ページ表示のテストを修正
  - サブ目標編集のテストを修正
  - 保存・キャンセルのテストを修正
  - ナビゲーションのテストを修正
  - _要件: 5.4_

- [x] 5.5 HistoryPanel.test.tsxの修正
  - `src/components/__tests__/HistoryPanel.test.tsx`を修正
  - 履歴パネル表示のテストを修正
  - 履歴アイテム表示のテストを修正
  - 履歴フィルタリングのテストを修正
  - 履歴ソートのテストを修正
  - _要件: 5.5_
  - _完了: 全5サブタスク完了（2025年11月12日）_

- [x] 6. テストカバレッジの向上
  - 未カバー箇所のテストを追加してカバレッジ80%以上を達成
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [x] 6.1 カバレッジレポートの生成と分析
  - `npm run test:coverage`を実行
  - カバレッジレポート（HTML）を確認
  - 未カバー箇所をリストアップ
  - 優先度の高い未カバー箇所を特定
  - _要件: 6.1, 6.3_

- [x] 6.2 重要機能のテスト追加
  - 進捗計算エンジンのカバレッジを100%にする
  - 認証機能のカバレッジを100%にする
  - API通信機能のカバレッジを100%にする
  - エラーハンドリングのカバレッジを100%にする
  - _要件: 6.2_

- [ ] 6.3 エッジケースのテスト追加
  - 境界値テストを追加（0, 1, -1, MAX, MIN）
  - null/undefinedのテストを追加
  - 空配列/空オブジェクトのテストを追加
  - 異常値のテストを追加
  - _要件: 6.1_

- [ ] 6.4 カバレッジレポートの最終確認
  - 全体のカバレッジが80%以上であることを確認
  - 重要機能のカバレッジが100%であることを確認
  - カバレッジレポートをHTML形式で出力
  - _要件: 6.1, 6.4_
  - _注記: タスク6.3-6.4は将来の品質向上タスクとして延期_

- [ ] 7. テスト実行の最適化
  - テスト実行時間を30分以内に短縮
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [ ] 7.1 並列実行の最適化
  - `vitest.config.ts`の並列実行設定を調整
  - CPU コア数に応じて`maxThreads`を設定
  - テストの分離を確認（各テストが独立）
  - 並列実行によるテスト実行時間の短縮を確認
  - _要件: 7.2_

- [ ] 7.2 遅いテストの特定と最適化
  - テスト実行時間を記録
  - 実行時間が5秒以上のテストをリストアップ
  - 遅いテストの原因を分析（不要な待機、重いモック等）
  - 遅いテストを最適化
  - _要件: 7.3_

- [ ] 7.3 テストデータのキャッシュ化
  - 頻繁に使用するテストデータをキャッシュ
  - `beforeAll`でテストデータを生成
  - `afterAll`でキャッシュをクリア
  - キャッシュによる高速化を確認
  - _要件: 7.2_

- [ ] 7.4 テスト実行時間の最終確認
  - 全テストを実行して実行時間を測定
  - 実行時間が30分以内であることを確認
  - 実行時間レポートを生成
  - _要件: 7.1, 7.4_

- [ ] 8. テスト結果の可視化
  - テスト結果を視覚的に確認できるようにする
  - _要件: 8.1, 8.2, 8.3, 8.4_
  - _注記: タスク8は将来の品質向上タスクとして延期_

- [ ] 8.1 コンソール出力の改善
  - リアルタイム進捗表示を実装
  - 成功・失敗・スキップの件数を表示
  - 実行時間を表示
  - カラー出力を追加（成功: 緑、失敗: 赤、スキップ: 黄）
  - _要件: 8.1_

- [ ] 8.2 HTML レポートの生成
  - `vitest.config.ts`にHTMLレポーター設定を追加
  - テスト結果の詳細をHTML形式で出力
  - カバレッジレポートをHTML形式で出力
  - 失敗したテストのスタックトレースを表示
  - _要件: 8.2, 8.3_

- [ ] 8.3 JUnit XML レポートの生成
  - `vitest.config.ts`にJUnitレポーター設定を追加
  - テスト結果をJUnit XML形式で出力
  - CI/CD（GitHub Actions）で使用できる形式で出力
  - _要件: 8.3_

- [ ] 8.4 テスト実行履歴の保存
  - テスト実行履歴を`test-results/history/`に保存
  - 実行日時、成功率、実行時間を記録
  - 履歴の可視化（グラフ化）を検討
  - _要件: 8.4_

- [ ] 9. CI/CD統合
  - GitHub ActionsでテストをCI/CD統合
  - _要件: 9.1, 9.2, 9.3, 9.4_

- [ ] 9.1 GitHub Actionsワークフローの作成
  - `.github/workflows/test.yml`を作成
  - プルリクエスト時にテストを自動実行
  - プッシュ時にテストを自動実行
  - タイムアウト設定を追加（30分）
  - _要件: 9.1_

- [ ] 9.2 テスト失敗時のプルリクエストブロック
  - テストが失敗した場合、プルリクエストをブロック
  - 失敗したテストの詳細をコメントで表示
  - カバレッジが80%未満の場合、プルリクエストをブロック
  - _要件: 9.2_

- [ ] 9.3 テスト成功時のマージ許可
  - テストが成功した場合、マージを許可
  - カバレッジレポートをアップロード（Codecov）
  - テスト結果をGitHub Actionsに報告
  - _要件: 9.3, 9.4_

- [ ] 9.4 CI/CD統合の最終確認
  - プルリクエストを作成してテストを実行
  - テストが自動実行されることを確認
  - テスト結果がGitHub Actionsに表示されることを確認
  - カバレッジレポートがアップロードされることを確認
  - _要件: 9.1, 9.4_

- [ ] 10. テストの保守性向上
  - テストコードの保守性を向上させる
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 10.1 テスト命名規則の統一
  - テスト名を「should + 期待する動作」形式に統一
  - テストグループ名を明確にする（describe）
  - テストの目的を明確にするコメントを追加
  - _要件: 10.1_

- [ ] 10.2 テストフィクスチャの作成
  - `src/test/fixtures/`ディレクトリを作成
  - 再利用可能なテストデータをフィクスチャとして保存
  - `userFixture.ts`、`goalFixture.ts`等を作成
  - フィクスチャを使用するようにテストを修正
  - _要件: 10.2_

- [ ] 10.3 モックパターンの統一
  - 一貫性のあるモックパターンを定義
  - `src/test/mocks/`ディレクトリを作成
  - `apiMock.ts`、`routerMock.ts`等を作成
  - モックを使用するようにテストを修正
  - _要件: 10.3_

- [ ] 10.4 テストドキュメントの作成
  - `docs/testing-guide.md`を作成
  - テストの書き方ガイドを記述
  - テストのベストプラクティスを記述
  - トラブルシューティングガイドを記述
  - _要件: 10.4_

- [ ] 10.5 テストコードレビュー
  - 全テストコードをレビュー
  - 命名規則、フィクスチャ、モックパターンの統一を確認
  - コメントの追加を確認
  - ベストプラクティスに従っているか確認
  - _要件: 10.5_

- [ ] 11. 最終検証とコード品質確認
  - 全テストが成功することを確認し、コード品質を確認
  - _要件: 全要件_

- [ ] 11.1 全テストの実行と成功確認
  - `npm run test:coverage`を実行
  - 全テストが成功することを確認（成功率95%以上）
  - 失敗テストが0件であることを確認
  - テスト実行時間が30分以内であることを確認
  - _要件: 全要件_

- [ ] 11.2 カバレッジの最終確認
  - カバレッジレポートを確認
  - 全体のカバレッジが80%以上であることを確認
  - 重要機能のカバレッジが100%であることを確認
  - 未カバー箇所が許容範囲内であることを確認
  - _要件: 6.1, 6.2_

- [ ] 11.3 パフォーマンスの最終確認
  - テスト実行時間を測定
  - 遅いテストがないことを確認（5秒以上のテストが0件）
  - 並列実行が正常に動作していることを確認
  - メモリ使用量が許容範囲内であることを確認
  - _要件: 7.1, 7.2, 7.3_

- [ ] 11.4 CI/CD統合の最終確認
  - GitHub Actionsでテストを実行
  - テストが自動実行されることを確認
  - テスト結果が正しく報告されることを確認
  - カバレッジレポートがアップロードされることを確認
  - _要件: 9.1, 9.2, 9.3, 9.4_

- [ ] 11.5 コード品質の最終確認
  - `npm run lint`を実行してエラー・警告が0件であることを確認
  - `npm run format:check`を実行してフォーマットが正しいことを確認
  - `npm run type-check`を実行して型エラーが0件であることを確認
  - テストコードのコメントが適切であることを確認
  - _要件: 10.1, 10.4, 10.5_

- [ ] 11.6 ドキュメントの最終確認
  - `docs/testing-guide.md`が完成していることを確認
  - テストの書き方ガイドが明確であることを確認
  - トラブルシューティングガイドが役立つことを確認
  - README.mdにテスト実行方法を記載
  - _要件: 10.4_

- [ ] 11.7 WBSの更新
  - `.kiro/steering/4-wbs.md`を更新
  - 2.4.5のタスク完了状況を記録
  - テスト成功率を記録（43.4% → 95%以上）
  - 次のタスクの優先順位を確認
  - _要件: 全要件_

## 注記

- 各タスクは、必ず`npm run format`を実行した上で、`npm run lint`を通してエラーと警告がゼロ件にする作業を含みます
- テスト実行時は、必ずタイムアウト設定をして実行し、操作不可能になる状況を絶対に起こさないでください
- テストは必ずバックグラウンドでタイムアウトを設定して実行してください
- テスト実行は、極力テスト実行の進捗をリアルタイム表示する形で実行してください
