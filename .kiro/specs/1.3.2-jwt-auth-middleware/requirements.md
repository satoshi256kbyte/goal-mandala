# 要件定義書

## 概要

JWT認証ミドルウェアを実装し、バックエンドAPIエンドポイントでのユーザー認証・認可機能を提供します。Amazon Cognitoから発行されたJWTトークンを検証し、保護されたAPIエンドポイントへのアクセス制御を行います。

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、APIエンドポイントにJWT認証機能を追加したいので、再利用可能な認証ミドルウェアが必要です

#### 受入基準

1. WHEN 有効なJWTトークンがAuthorizationヘッダーに含まれている場合 THEN システムはトークンを検証し、リクエストを次のハンドラーに渡すこと
2. WHEN 無効なJWTトークンが提供された場合 THEN システムは401 Unauthorizedエラーを返すこと
3. WHEN JWTトークンが提供されていない場合 THEN システムは401 Unauthorizedエラーを返すこと
4. WHEN JWTトークンの有効期限が切れている場合 THEN システムは401 Unauthorizedエラーを返すこと
5. WHEN 認証が成功した場合 THEN システムはユーザー情報をリクエストコンテキストに追加すること

### 要件2

**ユーザーストーリー:** 開発者として、Cognitoから発行されたJWTトークンを検証したいので、Cognito固有の検証ロジックが必要です

#### 受入基準

1. WHEN CognitoのJWTトークンを受信した場合 THEN システムはCognitoの公開鍵を使用してトークンの署名を検証すること
2. WHEN トークンのissuer（iss）クレームを検証する場合 THEN システムは設定されたCognito User PoolのISSUERと一致することを確認すること
3. WHEN トークンのaudience（aud）クレームを検証する場合 THEN システムは設定されたClient IDと一致することを確認すること
4. WHEN トークンのtoken_use クレームを検証する場合 THEN システムは"access"または"id"であることを確認すること

### 要件3

**ユーザーストーリー:** 開発者として、認証エラーを適切にハンドリングしたいので、詳細なエラー情報と統一されたエラーレスポンスが必要です

#### 受入基準

1. WHEN JWT検証でエラーが発生した場合 THEN システムは適切なHTTPステータスコードとエラーメッセージを返すこと
2. WHEN トークンの形式が不正な場合 THEN システムは400 Bad Requestエラーを返すこと
3. WHEN Cognito公開鍵の取得に失敗した場合 THEN システムは500 Internal Server Errorエラーを返すこと
4. WHEN エラーが発生した場合 THEN システムはセキュリティ上重要でない範囲でエラー詳細をログに記録すること

### 要件4

**ユーザーストーリー:** 開発者として、認証されたユーザー情報にアクセスしたいので、リクエストコンテキストからユーザー情報を取得できる仕組みが必要です

#### 受入基準

1. WHEN 認証が成功した場合 THEN システムはユーザーID、メールアドレス、その他のクレーム情報をリクエストコンテキストに設定すること
2. WHEN 後続のハンドラーでユーザー情報が必要な場合 THEN システムは型安全な方法でユーザー情報にアクセスできること
3. WHEN ユーザー情報が設定されている場合 THEN システムは必要な情報（sub、email、name等）が含まれていることを保証すること

### 要件5

**ユーザーストーリー:** 開発者として、パフォーマンスを最適化したいので、Cognito公開鍵のキャッシュ機能が必要です

#### 受入基準

1. WHEN Cognito公開鍵を初回取得した場合 THEN システムは公開鍵をメモリにキャッシュすること
2. WHEN キャッシュされた公開鍵が存在する場合 THEN システムはネットワーク通信を行わずにキャッシュから公開鍵を取得すること
3. WHEN 公開鍵のキャッシュが一定時間経過した場合 THEN システムは新しい公開鍵を取得してキャッシュを更新すること
4. WHEN 公開鍵による検証が失敗した場合 THEN システムはキャッシュをクリアして新しい公開鍵を取得すること

### 要件6

**ユーザーストーリー:** 開発者として、テスト環境での開発効率を向上させたいので、開発用のモック認証機能が必要です

#### 受入基準

1. WHEN 開発環境でモック認証が有効な場合 THEN システムは固定のテストユーザー情報を使用すること
2. WHEN 本番環境の場合 THEN システムは実際のCognito JWT検証を行うこと
3. WHEN 環境変数でモック認証の有効/無効を制御する場合 THEN システムは設定に従って適切な認証方式を選択すること
