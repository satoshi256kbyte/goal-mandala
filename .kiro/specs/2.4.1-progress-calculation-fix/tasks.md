# 実装計画

## タスクリスト

- [x] 1. ProgressValidatorの実装
  - ProgressValidatorクラスを新規作成し、進捗値の検証ロジックを一元管理する
  - `isValidProgress()`, `normalizeProgress()`, `filterValidProgresses()`, `calculateAverage()`メソッドを実装
  - _要件: 要件7.1, 要件7.2_

- [x] 1.1 ProgressValidatorのユニットテスト作成
  - 全メソッドのテストケースを作成
  - 境界値テスト（0, 50, 100, -1, 101, NaN）を含める
  - _要件: 要件7.5_

- [x] 2. TaskProgressCalculatorの修正
  - `calculateTaskProgressByStatus()`メソッドを実装
  - 4つのタスク状態（COMPLETED, IN_PROGRESS, NOT_STARTED, SKIPPED）に対応
  - _要件: 要件1.1, 要件1.2, 要件1.3_

- [x] 2.1 TaskProgressCalculatorのテスト修正
  - 完了タスク（100%）のテスト
  - 進行中タスク（50%）のテスト
  - 未着手タスク（0%）のテスト
  - スキップタスク（0%）のテスト
  - _要件: 要件7.5_

- [x] 3. ExecutionActionCalculatorの修正
  - タスク進捗の合計による平均計算に変更
  - 各タスクの状態に応じた進捗値を使用
  - _要件: 要件2.1, 要件2.5_

- [x] 3.1 ExecutionActionCalculatorのテスト修正
  - 全タスク完了（100%）のテスト
  - 半分完了・半分進行中（75%）のテスト
  - 全タスク未着手（0%）のテスト
  - タスクが存在しない場合（0%）のテスト
  - _要件: 要件2.4, 要件7.5_

- [x] 4. HabitActionCalculatorの修正
  - 連続日数計算ロジックを実装
  - 完了日時でソートし、日付の連続性をチェック
  - 最新の連続日数を使用して進捗を計算
  - _要件: 要件2.2_

- [x] 4.1 HabitActionCalculatorのテスト修正
  - 連続30日完了（100%）のテスト
  - 連続24日完了（80%達成、100%）のテスト
  - 連続12日完了（40%、50%進捗）のテスト
  - 途中で途切れた場合のテスト
  - タスクが存在しない場合（0%）のテスト
  - _要件: 要件2.2, 要件7.5_

- [x] 5. SubGoalProgressCalculatorの修正
  - ProgressValidatorを使用して無効な進捗値をフィルタリング
  - 無効な進捗値がある場合は警告ログを出力
  - 有効な進捗値のみで平均を計算
  - _要件: 要件3.1, 要件3.2, 要件3.5_

- [x] 5.1 SubGoalProgressCalculatorのテスト修正
  - 8つのアクション全て有効な場合のテスト
  - 一部のアクションが無効な場合のテスト
  - 全てのアクションが無効な場合のエラーテスト
  - アクションが存在しない場合（0%）のテスト
  - _要件: 要件3.3, 要件7.5_

- [x] 6. GoalProgressCalculatorの修正
  - ProgressValidatorを使用して無効な進捗値をフィルタリング
  - 無効な進捗値がある場合は警告ログを出力
  - 有効な進捗値のみで平均を計算
  - _要件: 要件4.1, 要件4.2, 要件4.5_

- [x] 6.1 GoalProgressCalculatorのテスト修正
  - 8つのサブ目標全て有効な場合のテスト
  - 一部のサブ目標が無効な場合のテスト
  - 全てのサブ目標が無効な場合のエラーテスト
  - サブ目標が存在しない場合（0%）のテスト
  - _要件: 要件4.3, 要件7.5_

- [x] 7. ErrorHandlerの修正
  - `getDefaultProgressValue()`メソッドを実装
  - エラー時のフォールバック値を0%に統一
  - エラーログのフォーマットを改善
  - _要件: 要件5.1, 要件5.3_

- [x] 7.1 ErrorHandlerのテスト修正
  - データ取得エラー時のフォールバック値テスト
  - データ検証エラー時のフォールバック値テスト
  - タイムアウトエラー時のフォールバック値テスト
  - 循環依存エラー時の例外スローテスト
  - _要件: 要件5.2, 要件5.4, 要件5.5, 要件7.5_

- [x] 8. 統合テストの実装
  - タスク完了から目標進捗更新までの全階層テスト
  - 複数タスク同時完了時の正しい進捗計算テスト
  - キャッシュの動作確認テスト
  - _要件: 要件7.2_

- [x] 9. パフォーマンステストの実装
  - 1000個のタスクを持つアクションの計算時間テスト（< 500ms）
  - 8個のサブ目標を持つ目標の計算時間テスト（< 2秒）
  - 深い階層の再計算時間テスト（< 2秒）
  - _要件: 要件6.1, 要件6.2, 要件6.3, 要件6.4_

- [x] 10. コード品質確認
  - `npm run format`を実行してコードフォーマット
  - `npm run lint`を実行してエラー・警告をゼロに
  - TypeScriptの型エラーがないことを確認
  - _要件: 要件7.1_

- [x] 11. 最終検証
  - 全27個のテストケースが成功することを確認
  - テストカバレッジが80%以上であることを確認
  - パフォーマンス要件を満たすことを確認
  - エラーハンドリングが適切に動作することを確認
  - _要件: 要件7.5_

- [x] 12. ドキュメント更新
  - 修正内容をREADMEに記載
  - APIドキュメントを更新
  - 変更履歴を記録
  - _要件: 要件7.1_
