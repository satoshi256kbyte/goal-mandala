# 要件定義書

## はじめに

進捗計算エンジンのテストが全て失敗している問題を修正します。進捗計算はシステムの中核機能であり、タスク→アクション→サブ目標→目標の階層的な進捗計算が正しく動作する必要があります。

## 用語集

- **System**: 目標管理曼荼羅システム
- **Progress Calculation Engine**: タスクからアクションへ、アクションからサブ目標へ、サブ目標から目標への進捗を階層的に計算するエンジン
- **Task**: アクションを実施するための具体的な作業単位
- **Action**: サブ目標を達成するための具体的な行動
- **SubGoal**: 目標を達成するために必要な8つの中間目標
- **Goal**: ユーザーが達成したい最終的な目標
- **Progress**: 0から100の範囲で表される達成度
- **Execution Action**: 実行すれば完了となるアクション
- **Habit Action**: 継続的に行う必要があるアクション

## 要件

### 要件1: タスク進捗計算の修正

**ユーザーストーリー:** システム管理者として、タスクの完了状態が正しく進捗に反映されることを確認したい

#### 受入基準

1. WHEN タスクの状態が「completed」に更新されたとき、THE System SHALL そのタスクの進捗を100%として計算する
2. WHEN タスクの状態が「in_progress」のとき、THE System SHALL そのタスクの進捗を50%として計算する
3. WHEN タスクの状態が「not_started」または「skipped」のとき、THE System SHALL そのタスクの進捗を0%として計算する
4. WHEN 複数のタスクが存在するとき、THE System SHALL 全タスクの進捗の平均値を計算する
5. WHEN タスクが存在しないとき、THE System SHALL 進捗を0%として返す

### 要件2: アクション進捗計算の修正

**ユーザーストーリー:** システム管理者として、アクションの進捗が配下のタスクの状態から正しく計算されることを確認したい

#### 受入基準

1. WHEN 実行アクションの全タスクが完了したとき、THE System SHALL そのアクションの進捗を100%として計算する
2. WHEN 習慣アクションのタスクが目標期間の80%以上継続されたとき、THE System SHALL そのアクションの進捗を100%として計算する
3. WHEN アクションに配下のタスクが存在するとき、THE System SHALL 全タスクの進捗の平均値をアクション進捗として計算する
4. WHEN アクションに配下のタスクが存在しないとき、THE System SHALL アクション進捗を0%として返す
5. WHEN アクションの種別が「execution」のとき、THE System SHALL 完了タスク数に基づいて進捗を計算する

### 要件3: サブ目標進捗計算の修正

**ユーザーストーリー:** システム管理者として、サブ目標の進捗が配下のアクションの状態から正しく計算されることを確認したい

#### 受入基準

1. WHEN サブ目標に8つのアクションが存在するとき、THE System SHALL 全アクションの進捗の平均値をサブ目標進捗として計算する
2. WHEN サブ目標のアクション数が8未満のとき、THE System SHALL 存在するアクションの進捗の平均値を計算する
3. WHEN サブ目標にアクションが存在しないとき、THE System SHALL サブ目標進捗を0%として返す
4. WHEN アクションの進捗が更新されたとき、THE System SHALL サブ目標の進捗を自動的に再計算する
5. WHEN 計算された進捗が小数点を含むとき、THE System SHALL 小数点第1位で四捨五入する

### 要件4: 目標進捗計算の修正

**ユーザーストーリー:** システム管理者として、目標の進捗が配下のサブ目標の状態から正しく計算されることを確認したい

#### 受入基準

1. WHEN 目標に8つのサブ目標が存在するとき、THE System SHALL 全サブ目標の進捗の平均値を目標進捗として計算する
2. WHEN 目標のサブ目標数が8未満のとき、THE System SHALL 存在するサブ目標の進捗の平均値を計算する
3. WHEN 目標にサブ目標が存在しないとき、THE System SHALL 目標進捗を0%として返す
4. WHEN サブ目標の進捗が更新されたとき、THE System SHALL 目標の進捗を自動的に再計算する
5. WHEN 計算された進捗が小数点を含むとき、THE System SHALL 小数点第1位で四捨五入する

### 要件5: 進捗計算エンジンのエラーハンドリング

**ユーザーストーリー:** システム管理者として、進捗計算中のエラーが適切に処理されることを確認したい

#### 受入基準

1. WHEN データベース接続エラーが発生したとき、THE System SHALL エラーログを記録し、適切なエラーメッセージを返す
2. WHEN 無効なデータ構造が渡されたとき、THE System SHALL バリデーションエラーを返す
3. WHEN 計算中に予期しないエラーが発生したとき、THE System SHALL エラーをキャッチし、デフォルト値（0%）を返す
4. WHEN 循環参照が検出されたとき、THE System SHALL エラーを返し、計算を中断する
5. WHEN タイムアウトが発生したとき、THE System SHALL 計算を中断し、タイムアウトエラーを返す

### 要件6: 進捗計算のパフォーマンス

**ユーザーストーリー:** システム管理者として、進捗計算が効率的に実行されることを確認したい

#### 受入基準

1. WHEN 単一タスクの進捗を計算するとき、THE System SHALL 100ミリ秒以内に結果を返す
2. WHEN アクション（最大64個のタスク）の進捗を計算するとき、THE System SHALL 500ミリ秒以内に結果を返す
3. WHEN サブ目標（最大8個のアクション）の進捗を計算するとき、THE System SHALL 1秒以内に結果を返す
4. WHEN 目標（最大8個のサブ目標）の進捗を計算するとき、THE System SHALL 2秒以内に結果を返す
5. WHEN 進捗計算が実行されるとき、THE System SHALL データベースクエリを最小限に抑える

### 要件7: テストカバレッジの確保

**ユーザーストーリー:** 開発者として、進捗計算エンジンの全機能がテストでカバーされていることを確認したい

#### 受入基準

1. WHEN ユニットテストを実行するとき、THE System SHALL 進捗計算エンジンのコードカバレッジが80%以上である
2. WHEN 統合テストを実行するとき、THE System SHALL 全ての階層（タスク→アクション→サブ目標→目標）の進捗計算が検証される
3. WHEN エッジケーステストを実行するとき、THE System SHALL 空データ、最大データ、無効データのケースが検証される
4. WHEN パフォーマンステストを実行するとき、THE System SHALL 要件6で定義された時間制約が検証される
5. WHEN 全テストを実行するとき、THE System SHALL 全27個のテストケースが成功する
