# 振り返り機能 要件定義

## User Stories

### US-1: 振り返り入力

**As a** ユーザー  
**I want to** 目標達成状況を振り返り、改善点を記録したい  
**So that** 次のアクションに活かすことができる

**Acceptance Criteria:**
- 振り返り入力画面にアクセスできる
- 総括を入力できる（必須、最大1000文字）
- 惜しかったアクションを入力できる（任意、最大500文字）
- 思ったより進まなかったアクションを入力できる（任意、最大500文字）
- 未着手となったアクションを入力できる（任意、最大500文字）
- 保存ボタンをクリックすると、振り返りが保存される
- 保存後、振り返り履歴画面に遷移する

### US-2: 振り返り履歴表示

**As a** ユーザー  
**I want to** 過去の振り返りを一覧で確認したい  
**So that** 成長の軌跡を振り返ることができる

**Acceptance Criteria:**
- 振り返り履歴画面にアクセスできる
- 振り返り一覧が新しい順に表示される
- 各振り返りの作成日時が表示される
- 各振り返りの総括（最初の100文字）が表示される
- 振り返りをクリックすると、詳細が表示される

### US-3: 振り返り詳細表示

**As a** ユーザー  
**I want to** 振り返りの詳細を確認したい  
**So that** 過去の振り返り内容を詳しく確認できる

**Acceptance Criteria:**
- 振り返り詳細画面にアクセスできる
- 総括が表示される
- 惜しかったアクションが表示される
- 思ったより進まなかったアクションが表示される
- 未着手となったアクションが表示される
- 作成日時が表示される
- 編集ボタンをクリックすると、編集画面に遷移する
- 削除ボタンをクリックすると、確認ダイアログが表示される

### US-4: 振り返り編集

**As a** ユーザー  
**I want to** 振り返りを編集したい  
**So that** 内容を修正できる

**Acceptance Criteria:**
- 振り返り編集画面にアクセスできる
- 既存の振り返り内容が表示される
- 総括を編集できる
- 惜しかったアクションを編集できる
- 思ったより進まなかったアクションを編集できる
- 未着手となったアクションを編集できる
- 保存ボタンをクリックすると、振り返りが更新される
- 保存後、振り返り詳細画面に遷移する

### US-5: 振り返り削除

**As a** ユーザー  
**I want to** 振り返りを削除したい  
**So that** 不要な振り返りを削除できる

**Acceptance Criteria:**
- 削除ボタンをクリックすると、確認ダイアログが表示される
- 確認ダイアログで「削除」をクリックすると、振り返りが削除される
- 削除後、振り返り履歴画面に遷移する
- 確認ダイアログで「キャンセル」をクリックすると、削除されない

## 機能要件

### FR-1: 振り返り入力

- 振り返り入力フォームを提供する
- 総括は必須項目とする
- 惜しかったアクション、思ったより進まなかったアクション、未着手となったアクションは任意項目とする
- 各項目の文字数制限を設ける
- バリデーションエラーを表示する

### FR-2: 振り返り保存

- 振り返りをデータベースに保存する
- 保存時に作成日時を記録する
- 保存時にユーザーIDと目標IDを記録する

### FR-3: 振り返り一覧表示

- 振り返り一覧を新しい順に表示する
- 各振り返りの作成日時と総括（最初の100文字）を表示する
- ページネーション機能を提供する（10件/ページ）

### FR-4: 振り返り詳細表示

- 振り返りの全項目を表示する
- 作成日時と更新日時を表示する

### FR-5: 振り返り編集

- 既存の振り返り内容を編集できる
- 更新時に更新日時を記録する

### FR-6: 振り返り削除

- 振り返りを削除できる
- 削除前に確認ダイアログを表示する

## 非機能要件

### NFR-1: パフォーマンス

- 振り返り一覧の表示は2秒以内に完了する
- 振り返り詳細の表示は1秒以内に完了する
- 振り返りの保存は3秒以内に完了する

### NFR-2: セキュリティ

- 認証されたユーザーのみが振り返りにアクセスできる
- ユーザーは自分の振り返りのみにアクセスできる
- 入力値のサニタイゼーションを実施する

### NFR-3: 可用性

- システム稼働率99.5%以上を維持する
- エラー発生時は適切なエラーメッセージを表示する

### NFR-4: 保守性

- コードカバレッジ80%以上を維持する
- APIドキュメントを整備する
- 運用ガイドを整備する

## データモデル

### Reflection（振り返り）

```typescript
interface Reflection {
  id: string;                    // UUID、主キー
  goalId: string;                // 外部キー（Goal）
  userId: string;                // 外部キー（User）
  summary: string;               // 総括（必須、最大1000文字）
  regretfulActions?: string;     // 惜しかったアクション（任意、最大500文字）
  slowProgressActions?: string;  // 思ったより進まなかったアクション（任意、最大500文字）
  untouchedActions?: string;     // 未着手となったアクション（任意、最大500文字）
  createdAt: Date;               // 作成日時
  updatedAt: Date;               // 更新日時
}
```

## API仕様

### POST /api/reflections

振り返りを作成する

**リクエスト:**
```json
{
  "goalId": "goal-123",
  "summary": "目標達成に向けて順調に進んでいる",
  "regretfulActions": "アクション1が惜しかった",
  "slowProgressActions": "アクション2が思ったより進まなかった",
  "untouchedActions": "アクション3が未着手となった"
}
```

**レスポンス:**
```json
{
  "id": "reflection-123",
  "goalId": "goal-123",
  "userId": "user-123",
  "summary": "目標達成に向けて順調に進んでいる",
  "regretfulActions": "アクション1が惜しかった",
  "slowProgressActions": "アクション2が思ったより進まなかった",
  "untouchedActions": "アクション3が未着手となった",
  "createdAt": "2025-12-10T10:00:00.000Z",
  "updatedAt": "2025-12-10T10:00:00.000Z"
}
```

### GET /api/reflections

振り返り一覧を取得する

**クエリパラメータ:**
- `goalId` (string, required): 目標ID
- `page` (number, optional): ページ番号（デフォルト: 1）
- `limit` (number, optional): 1ページあたりの件数（デフォルト: 10）

**レスポンス:**
```json
{
  "reflections": [
    {
      "id": "reflection-123",
      "goalId": "goal-123",
      "summary": "目標達成に向けて順調に進んでいる",
      "createdAt": "2025-12-10T10:00:00.000Z"
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 10
}
```

### GET /api/reflections/:id

振り返り詳細を取得する

**レスポンス:**
```json
{
  "id": "reflection-123",
  "goalId": "goal-123",
  "userId": "user-123",
  "summary": "目標達成に向けて順調に進んでいる",
  "regretfulActions": "アクション1が惜しかった",
  "slowProgressActions": "アクション2が思ったより進まなかった",
  "untouchedActions": "アクション3が未着手となった",
  "createdAt": "2025-12-10T10:00:00.000Z",
  "updatedAt": "2025-12-10T10:00:00.000Z"
}
```

### PUT /api/reflections/:id

振り返りを更新する

**リクエスト:**
```json
{
  "summary": "目標達成に向けて順調に進んでいる（更新）",
  "regretfulActions": "アクション1が惜しかった（更新）",
  "slowProgressActions": "アクション2が思ったより進まなかった（更新）",
  "untouchedActions": "アクション3が未着手となった（更新）"
}
```

**レスポンス:**
```json
{
  "id": "reflection-123",
  "goalId": "goal-123",
  "userId": "user-123",
  "summary": "目標達成に向けて順調に進んでいる（更新）",
  "regretfulActions": "アクション1が惜しかった（更新）",
  "slowProgressActions": "アクション2が思ったより進まなかった（更新）",
  "untouchedActions": "アクション3が未着手となった（更新）",
  "createdAt": "2025-12-10T10:00:00.000Z",
  "updatedAt": "2025-12-10T10:05:00.000Z"
}
```

### DELETE /api/reflections/:id

振り返りを削除する

**レスポンス:**
```json
{
  "message": "振り返りを削除しました"
}
```

## エラーハンドリング

### バリデーションエラー

- 総括が空の場合: "総括は必須です"
- 総括が1000文字を超える場合: "総括は1000文字以内で入力してください"
- 惜しかったアクションが500文字を超える場合: "惜しかったアクションは500文字以内で入力してください"
- 思ったより進まなかったアクションが500文字を超える場合: "思ったより進まなかったアクションは500文字以内で入力してください"
- 未着手となったアクションが500文字を超える場合: "未着手となったアクションは500文字以内で入力してください"

### 認証エラー

- 認証トークンが無効または期限切れ: "認証に失敗しました"
- ユーザーが振り返りにアクセスする権限がない: "アクセス権限がありません"

### データエラー

- 振り返りが見つからない: "振り返りが見つかりません"
- 目標が見つからない: "目標が見つかりません"

## テスト要件

### プロパティベーステスト

- 振り返り作成の冪等性
- 振り返り一覧の完全性
- 振り返り更新の原子性
- 振り返り削除の安全性
- バリデーションの正確性

### 統合テスト

- 振り返り作成から詳細表示までのフロー
- 振り返り編集から更新までのフロー
- 振り返り削除のフロー
- ページネーションの動作

### E2Eテスト

- ユーザーが振り返りを入力し、保存できる
- ユーザーが振り返り履歴を確認できる
- ユーザーが振り返りを編集できる
- ユーザーが振り返りを削除できる

## 制約事項

- 振り返りは目標ごとに管理される
- 振り返りは削除されると復元できない
- 振り返りの共有機能は Phase 2 で実装予定
