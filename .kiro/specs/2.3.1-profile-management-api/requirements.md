# 要件定義書

## はじめに

この要件定義書は、ユーザープロフィール情報の管理APIの実装について定義します。ユーザーの基本情報（業種、組織規模、職種、役職）の取得、更新、削除機能を提供し、AI生成時のコンテキスト情報として活用します。

## 要件

### 要件1: プロフィール取得API

**ユーザーストーリー:** ユーザーとして、自分のプロフィール情報を取得したい。そうすることで、現在の登録情報を確認できる。

#### 受入基準

1. WHEN GET /api/profile エンドポイントにリクエストを送信する THEN 認証されたユーザーのプロフィール情報が返される
2. WHEN 認証トークンが有効である THEN ユーザーIDが抽出され、該当ユーザーの情報が取得される
3. WHEN プロフィール情報が存在する THEN id、email、name、industry、company_size、job_title、position、created_at、updated_at が返される
4. WHEN プロフィール情報が存在しない THEN 404 Not Foundエラーが返される
5. WHEN レスポンスを返す THEN 適切なContent-Type（application/json）が設定される
6. WHEN レスポンスを返す THEN CORSヘッダーが適切に設定される

### 要件2: プロフィール更新API

**ユーザーストーリー:** ユーザーとして、自分のプロフィール情報を更新したい。そうすることで、最新の状況を反映し、より適切なAI生成結果を得られる。

#### 受入基準

1. WHEN PUT /api/profile エンドポイントにリクエストを送信する THEN 認証されたユーザーのプロフィール情報が更新される
2. WHEN リクエストボディに更新情報が含まれる THEN 指定されたフィールドのみが更新される
3. WHEN name フィールドを更新する THEN 1文字以上50文字以内であることが検証される
4. WHEN industry フィールドを更新する THEN 100文字以内であることが検証される
5. WHEN company_size フィールドを更新する THEN 50文字以内であることが検証される
6. WHEN job_title フィールドを更新する THEN 100文字以内であることが検証される
7. WHEN position フィールドを更新する THEN 100文字以内であることが検証される
8. WHEN 更新が成功する THEN updated_at が自動的に更新される
9. WHEN 更新が成功する THEN 更新後のプロフィール情報が返される
10. WHEN バリデーションエラーが発生する THEN 400 Bad Requestと具体的なエラーメッセージが返される

### 要件3: プロフィール削除API

**ユーザーストーリー:** ユーザーとして、自分のアカウントとプロフィール情報を削除したい。そうすることで、サービスの利用を完全に終了できる。

#### 受入基準

1. WHEN DELETE /api/profile エンドポイントにリクエストを送信する THEN 認証されたユーザーのプロフィール情報が削除される
2. WHEN プロフィールを削除する THEN 関連する全ての目標、サブ目標、アクション、タスクがカスケード削除される
3. WHEN 削除が成功する THEN 204 No Contentステータスコードが返される
4. WHEN 削除後に同じユーザーIDでアクセスする THEN 404 Not Foundエラーが返される
5. WHEN データベースエラーが発生する THEN トランザクションがロールバックされる

### 要件4: プロフィール検証機能

**ユーザーストーリー:** システム開発者として、不正な入力データを早期に検出したい。そうすることで、データの整合性を保ち、適切なフィードバックを提供できる。

#### 受入基準

1. WHEN name フィールドが空である THEN バリデーションエラーが返される
2. WHEN name フィールドが50文字を超える THEN バリデーションエラーが返される
3. WHEN industry フィールドが100文字を超える THEN バリデーションエラーが返される
4. WHEN company_size フィールドが50文字を超える THEN バリデーションエラーが返される
5. WHEN job_title フィールドが100文字を超える THEN バリデーションエラーが返される
6. WHEN position フィールドが100文字を超える THEN バリデーションエラーが返される
7. WHEN 不正な文字が含まれる THEN サニタイズ処理が適用される
8. WHEN バリデーションエラーが発生する THEN 具体的なフィールド名とエラー理由が返される

### 要件5: 認証・認可機能

**ユーザーストーリー:** システム開発者として、プロフィール情報へのアクセスを適切に制御したい。そうすることで、セキュリティを確保し、他人の情報への不正アクセスを防げる。

#### 受入基準

1. WHEN 認証トークンが含まれていない THEN 401 Unauthorizedエラーが返される
2. WHEN 認証トークンが無効である THEN 401 Unauthorizedエラーが返される
3. WHEN 認証トークンが期限切れである THEN 401 Unauthorizedエラーが返される
4. WHEN 認証されたユーザーが自分のプロフィールにアクセスする THEN アクセスが許可される
5. WHEN JWTトークンからユーザーIDが抽出される THEN そのユーザーIDに紐づくプロフィールのみがアクセス可能である

### 要件6: エラーハンドリング

**ユーザーストーリー:** ユーザーとして、エラーが発生した場合に適切なフィードバックを受け取りたい。そうすることで、問題を理解し、適切に対処できる。

#### 受入基準

1. WHEN データベース接続エラーが発生する THEN 500 Internal Server Errorと「データベース接続に失敗しました」というメッセージが返される
2. WHEN データベースクエリエラーが発生する THEN 500 Internal Server Errorと適切なエラーメッセージが返される
3. WHEN 予期しないエラーが発生する THEN 500 Internal Server Errorと「予期しないエラーが発生しました」というメッセージが返される
4. WHEN エラーが発生する THEN エラー詳細がログに記録される
5. WHEN エラーログを記録する THEN 機密情報（パスワード、トークン）がマスキングされる
6. WHEN エラーレスポンスを返す THEN エラーコード、メッセージ、タイムスタンプが含まれる

### 要件7: レスポンス形式

**ユーザーストーリー:** フロントエンド開発者として、一貫性のあるレスポンス形式を受け取りたい。そうすることで、UIでの表示処理が容易になる。

#### 受入基準

1. WHEN プロフィール取得が成功する THEN レスポンスに success: true とプロフィールデータが含まれる
2. WHEN プロフィール更新が成功する THEN レスポンスに success: true と更新後のプロフィールデータが含まれる
3. WHEN プロフィール削除が成功する THEN 204 No Contentステータスコードが返される
4. WHEN エラーが発生する THEN レスポンスに success: false、error オブジェクト（code、message）が含まれる
5. WHEN レスポンスを返す THEN 適切なContent-Type（application/json）が設定される
6. WHEN レスポンスを返す THEN CORSヘッダーが適切に設定される

### 要件8: パフォーマンス要件

**ユーザーストーリー:** ユーザーとして、プロフィール情報を素早く取得・更新したい。そうすることで、ストレスなくサービスを利用できる。

#### 受入基準

1. WHEN プロフィール取得APIを呼び出す THEN 95%のリクエストが500ms以内に完了する
2. WHEN プロフィール更新APIを呼び出す THEN 95%のリクエストが1秒以内に完了する
3. WHEN プロフィール削除APIを呼び出す THEN 95%のリクエストが2秒以内に完了する
4. WHEN データベースクエリを実行する THEN 適切なインデックスが使用される
5. WHEN 同時アクセスが発生する THEN データベース接続プールが効率的に管理される

### 要件9: セキュリティ要件

**ユーザーストーリー:** システム開発者として、プロフィール情報を安全に管理したい。そうすることで、個人情報の漏洩や不正アクセスを防げる。

#### 受入基準

1. WHEN プロフィール情報を取得する THEN HTTPS通信が強制される
2. WHEN プロフィール情報を更新する THEN 入力値がサニタイズされる
3. WHEN プロフィール情報を更新する THEN SQLインジェクション対策が適用される
4. WHEN プロフィール情報を更新する THEN XSS対策が適用される
5. WHEN エラーログを記録する THEN 機密情報がマスキングされる
6. WHEN APIレート制限を超える THEN 429 Too Many Requestsエラーが返される

### 要件10: 監視とログ

**ユーザーストーリー:** システム運用者として、APIの動作状況を監視したい。そうすることで、問題を早期に発見し、適切に対処できる。

#### 受入基準

1. WHEN APIリクエストを受信する THEN リクエストID、ユーザーID、エンドポイント、メソッドがログに記録される
2. WHEN API処理が完了する THEN 処理時間、ステータスコード、レスポンスサイズがログに記録される
3. WHEN エラーが発生する THEN エラー詳細、スタックトレース、コンテキスト情報がログに記録される
4. WHEN ログを出力する THEN JSON形式の構造化ログが使用される
5. WHEN CloudWatchにログを送信する THEN ログレベル（INFO、WARN、ERROR）が適切に設定される
6. WHEN CloudWatchアラームを設定する THEN エラー率が5%を超えた場合にアラートが発報される
7. WHEN CloudWatchアラームを設定する THEN レスポンス時間が2秒を超えた場合にアラートが発報される
