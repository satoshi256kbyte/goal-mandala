# 実装タスクリスト

## 概要

このタスクリストは、プロフィール管理APIの実装手順を定義します。ユーザーの基本情報（業種、組織規模、職種、役職）の取得、更新、削除機能を提供し、既存の認証システムと統合します。

## タスク一覧

- [x] 1. プロジェクト基盤とセットアップ
- [x] 1.1 型定義ファイルの作成
  - types/profile.types.tsを作成
  - UserProfile、UpdateProfileRequest、ProfileResponse、ErrorResponseインターフェースを定義
  - _要件: 1.1, 2.1, 7.1_
- [x] 1.2 バリデーションスキーマの定義
  - schemas/profile.schema.tsを作成
  - ProfileUpdateSchemaをZodで定義
  - 各フィールドの文字数制限を設定
  - _要件: 2.3, 2.4, 2.5, 2.6, 2.7, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
- [x] 1.3 エラークラスの定義
  - errors/profile.errors.tsを作成
  - ValidationError、NotFoundError、DatabaseErrorクラスを定義
  - _要件: 6.1, 6.2, 6.3_
- [x] 1.4 テストセットアップ
  - 既存のJest設定を利用
  - テストデータベースの準備
  - _要件: 全要件_
- [x] 1.5 npm run formatとnpm run lintの実行
  - コード品質チェック
  - エラー・警告のゼロ化
- _要件: 1.1, 2.1, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 6.1, 6.2, 6.3, 7.1_

- [x] 2. ProfileValidationServiceの実装
- [x] 2.1 ProfileValidationServiceのテスト作成
  - services/__tests__/profile-validation.service.test.tsを作成
  - validateUpdateRequest()のテストケース作成
  - sanitizeInput()のテストケース作成
  - 各フィールドのバリデーションテスト
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8_
- [x] 2.2 ProfileValidationServiceクラスの作成
  - services/profile-validation.service.tsファイル作成
  - IProfileValidationServiceインターフェースの実装
  - _要件: 4.1_
- [x] 2.3 validateUpdateRequestメソッドの実装
  - ProfileUpdateSchemaを使用した検証
  - Zodエラーのハンドリング
  - ValidationErrorのスロー
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.8_
- [x] 2.4 sanitizeInputメソッドの実装
  - HTMLタグの除去
  - 特殊文字のエスケープ
  - _要件: 4.7, 9.2, 9.4_
- [x] 2.5 npm run formatとnpm run lintの実行
  - コード品質チェック
  - エラー・警告のゼロ化
- _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 9.2, 9.4_

- [x] 3. ProfileServiceの実装
- [x] 3.1 ProfileServiceのテスト作成
  - services/__tests__/profile.service.test.tsを作成
  - getProfile()のテストケース作成
  - updateProfile()のテストケース作成
  - deleteProfile()のテストケース作成
  - エラーハンドリングのテスト
  - _要件: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.8, 2.9, 2.10, 3.1, 3.2, 3.3, 3.4, 3.5_
- [x] 3.2 ProfileServiceクラスの作成
  - services/profile.service.tsファイル作成
  - IProfileServiceインターフェースの実装
  - PrismaClientのインスタンス化
  - _要件: 1.1, 2.1, 3.1_
- [x] 3.3 getProfileメソッドの実装
  - Prisma.user.findUnique()の実装
  - 必要なフィールドのみをSELECT
  - NotFoundErrorのスロー
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_
- [x] 3.4 updateProfileメソッドの実装
  - バリデーション処理
  - Prisma.user.update()の実装
  - updated_atの自動更新
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10_
- [x] 3.5 deleteProfileメソッドの実装
  - トランザクション内での削除
  - Prisma.user.delete()の実装
  - カスケード削除の確認
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_
- [x] 3.6 エラーハンドリングの実装
  - データベースエラーのキャッチ
  - DatabaseErrorのスロー
  - エラーログの記録
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_
- [x] 3.7 npm run formatとnpm run lintの実行
  - コード品質チェック
  - エラー・警告のゼロ化
- _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10, 3.1, 3.2, 3.3, 3.4, 3.5, 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 4. Lambda Handlerの実装
- [x] 4.1 ProfileHandlerのテスト作成
  - handlers/__tests__/profile.test.tsを作成
  - GET /api/profileのテストケース作成
  - PUT /api/profileのテストケース作成
  - DELETE /api/profileのテストケース作成
  - 認証エラーのテスト
  - バリデーションエラーのテスト
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.9, 2.10, 3.1, 3.3, 3.4, 5.1, 5.2, 5.3, 5.4, 5.5_
- [x] 4.2 ProfileHandlerの作成
  - handlers/profile.tsファイル作成
  - Honoアプリケーションの設定
  - エンドポイントの定義
  - _要件: 1.1, 2.1, 3.1_
- [x] 4.3 GET /api/profileエンドポイントの実装
  - authMiddlewareの適用
  - userIdの抽出
  - ProfileService.getProfile()の呼び出し
  - レスポンスの整形
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 5.1, 5.2, 5.3, 5.4, 5.5, 7.1, 7.5, 7.6_
- [x] 4.4 PUT /api/profileエンドポイントの実装
  - authMiddlewareの適用
  - リクエストボディの取得
  - ProfileService.updateProfile()の呼び出し
  - レスポンスの整形
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10, 5.1, 5.2, 5.3, 5.4, 5.5, 7.2, 7.5, 7.6_
- [x] 4.5 DELETE /api/profileエンドポイントの実装
  - authMiddlewareの適用
  - ProfileService.deleteProfile()の呼び出し
  - 204 No Contentレスポンスの返却
  - _要件: 3.1, 3.2, 3.3, 3.4, 5.1, 5.2, 5.3, 5.4, 5.5, 7.3_
- [x] 4.6 エラーハンドリングの実装
  - app.onError()の実装
  - エラー種別ごとのHTTPステータスコード設定
  - エラーレスポンスの整形
  - エラーログの記録
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 7.4_
- [x] 4.7 CORSヘッダーの設定
  - CORSミドルウェアの適用
  - 適切なヘッダーの設定
  - _要件: 1.6, 7.6_
- [x] 4.8 npm run formatとnpm run lintの実行
  - コード品質チェック
  - エラー・警告のゼロ化
- _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10, 3.1, 3.2, 3.3, 3.4, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [x] 5. セキュリティ機能の実装
- [x] 5.1 認証ミドルウェアの統合
  - 既存のauthMiddlewareを使用
  - JWT検証の確認
  - userIdの抽出確認
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_
- [x] 5.2 入力サニタイズの実装
  - ProfileValidationService.sanitizeInput()の使用
  - XSS対策の確認
  - _要件: 9.2, 9.4_
- [x] 5.3 SQLインジェクション対策の確認
  - Prismaのパラメータ化クエリ確認
  - _要件: 9.3_
- [x] 5.4 機密情報マスキングの実装
  - エラーログでの機密情報マスキング
  - 既存のセキュリティユーティリティ関数の使用
  - _要件: 6.5, 9.5_
- [x] 5.5 セキュリティテストの作成
  - 認証エラーのテスト
  - XSS対策のテスト
  - SQLインジェクション対策のテスト
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 9.1, 9.2, 9.3, 9.4, 9.5_
- [x] 5.6 npm run formatとnpm run lintの実行
  - コード品質チェック
  - エラー・警告のゼロ化
- _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 6.5, 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 6. 監視とログの実装
- [x] 6.1 構造化ログ出力の実装
  - 既存のlogger（utils/logger.ts）を使用
  - logInfo()、logError()関数の実装
  - requestId、userId、method、path、処理時間の記録
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_
- [x] 6.2 処理時間計測の実装
  - 開始時刻と終了時刻の記録
  - 処理時間の計算とログ出力
  - _要件: 10.2_
- [x] 6.3 ログ出力のテスト
  - ログ出力の確認テスト
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_
- [x] 6.4 npm run formatとnpm run lintの実行
  - コード品質チェック
  - エラー・警告のゼロ化
- _要件: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 7. CDKインフラの実装
- [x] 7.1 Lambda関数定義の作成
  - packages/infrastructure/src/stacks/内の既存スタックに追加
  - ProfileFunction定義
  - メモリサイズ（512MB）、タイムアウト（10秒）、同時実行数（10）の設定
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_
- [x] 7.2 API Gatewayエンドポイントの追加
  - GET /api/profileエンドポイント追加
  - PUT /api/profileエンドポイント追加
  - DELETE /api/profileエンドポイント追加
  - Lambda統合の設定
  - _要件: 1.1, 2.1, 3.1_
- [x] 7.3 Cognito Authorizerの設定
  - 既存のCognito Authorizerを使用
  - 認証タイプの設定
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_
- [x] 7.4 IAM権限の設定
  - データベースアクセス権限（既存のroleを使用）
  - CloudWatch Logs書き込み権限（既存）
  - _要件: 5.1_
- [x] 7.5 CloudWatchアラームの設定
  - エラー率アラーム（閾値: 5%）
  - 処理時間アラーム（閾値: 2秒）
  - SNS通知設定
  - _要件: 10.6, 10.7_
- [x] 7.6 環境変数の設定
  - DATABASE_URL
  - LOG_LEVEL
  - CORS_ORIGIN
  - _要件: 全要件_
- [x] 7.7 CDKスタックのテスト
  - cdk synthの実行確認
  - スタック定義の検証
  - _要件: 全要件_
- [x] 7.8 npm run formatとnpm run lintの実行
  - コード品質チェック
  - エラー・警告のゼロ化
- _要件: 1.1, 2.1, 3.1, 5.1, 5.2, 5.3, 5.4, 5.5, 8.1, 8.2, 8.3, 8.4, 8.5, 10.6, 10.7_

- [x] 8. 統合テストの実装
- [x] 8.1 プロフィール取得フローのテスト
  - 認証トークン取得
  - GET /api/profileリクエスト
  - レスポンス検証
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_
- [x] 8.2 プロフィール更新フローのテスト
  - 認証トークン取得
  - PUT /api/profileリクエスト
  - レスポンス検証
  - データベース確認
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10_
- [x] 8.3 プロフィール削除フローのテスト
  - 認証トークン取得
  - DELETE /api/profileリクエスト
  - レスポンス検証
  - カスケード削除の確認
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_
- [x] 8.4 認証エラーのテスト
  - 認証トークンなしのテスト
  - 無効なトークンのテスト
  - 期限切れトークンのテスト
  - _要件: 5.1, 5.2, 5.3_
- [x] 8.5 バリデーションエラーのテスト
  - 各フィールドのバリデーションエラー
  - エラーレスポンスの確認
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8_
- [x] 8.6 パフォーマンステストの実施
  - レスポンス時間の測定
  - 同時アクセステスト
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_
- [x] 8.7 テストカバレッジの確認（80%以上）
  - npm run test:coverageの実行
  - カバレッジレポートの確認
  - _要件: 全要件_
- [x] 8.8 npm run formatとnpm run lintの実行
  - コード品質チェック
  - エラー・警告のゼロ化
- _要件: 全要件_

- [x] 9. ドキュメントの作成
- [x] 9.1 API仕様書の作成
  - packages/backend/docs/profile-api-specification.mdを作成
  - エンドポイント、リクエスト、レスポンスの詳細
  - サンプルコードの追加
  - _要件: 全要件_
- [x] 9.2 エラーコード一覧の作成
  - エラーコードとメッセージの一覧
  - 対処方法の記載
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_
- [x] 9.3 運用ガイドの作成
  - packages/backend/docs/profile-operations-guide.mdを作成
  - 監視項目、アラート対応手順
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_
- [x] 9.4 トラブルシューティングガイドの作成
  - よくある問題と解決方法
  - ログの確認方法
  - _要件: 全要件_
- [x] 9.5 READMEの更新
  - 機能概要の追加
  - セットアップ手順の更新
  - プロフィール管理機能の説明
  - _要件: 全要件_

- [x] 10. 最終検証とコード品質確認
- [x] 10.1 全テストの実行と成功確認
  - npm run testの実行
  - 全テストの成功確認
  - _要件: 全要件_
- [x] 10.2 テストカバレッジの確認（80%以上）
  - npm run test:coverageの実行
  - カバレッジレポートの確認
  - _要件: 全要件_
- [x] 10.3 ESLintエラー・警告のゼロ化
  - npm run lintの実行
  - エラー・警告の修正
  - _要件: 全要件_
- [x] 10.4 TypeScript型エラーのゼロ化
  - npm run type-checkの実行
  - 型エラーの修正
  - _要件: 全要件_
- [x] 10.5 セキュリティスキャンの実行
  - npm auditの実行
  - 脆弱性の確認と対応
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_
- [x] 10.6 コードレビューの実施
  - コードの可読性確認
  - ベストプラクティスの確認
  - _要件: 全要件_
- [x] 10.7 最終的なnpm run formatとnpm run lintの実行
  - コード品質の最終確認
  - _要件: 全要件_

## タスクの依存関係

```
1. プロジェクト基盤
   ↓
2. ProfileValidationService（バリデーション）
   ↓
3. ProfileService（ビジネスロジック）
   ↓
4. Lambda Handler
   ↓
5. セキュリティ機能
   ↓
6. 監視とログ
   ↓
7. CDKインフラ
   ↓
8. 統合テスト
   ↓
9. ドキュメント
   ↓
10. 最終検証
```

## 実装状況サマリー

### 完了済みタスク

- なし（未着手）

### 次に実装すべきタスク

- タスク1: プロジェクト基盤とセットアップ
- タスク2: ProfileValidationServiceの実装
- タスク3: ProfileServiceの実装
- タスク4: Lambda Handlerの実装

## 注意事項

- 各タスクは、必ず`npm run format`を実行した上で、`npm run lint`を通してエラーと警告がゼロ件にする作業を含めてください
- テストファーストの構成にしてください。テストコードの実装 → 実装 → テストの順にしてください
- 各タスク完了後は、必ずGitコミットを行ってください
- 統合テストは実際のデータベースを使用して実行してください
- 既存の認証ミドルウェア（authMiddleware）を活用してください
- 既存のロガー（utils/logger.ts）とセキュリティユーティリティ（utils/security.ts）を活用してください

## 推定工数

- タスク1: 0.5人日（プロジェクト基盤）
- タスク2: 0.5人日（ProfileValidationService）
- タスク3: 1人日（ProfileService）
- タスク4: 1.5人日（Lambda Handler）
- タスク5: 0.5人日（セキュリティ機能）
- タスク6: 0.5人日（監視とログ）
- タスク7: 1人日（CDKインフラ）
- タスク8: 1.5人日（統合テスト）
- タスク9: 0.5人日（ドキュメント）
- タスク10: 0.5人日（最終検証）

__合計: 8人日__

## 成功基準

1. 全てのタスクが完了している
2. テストカバレッジが80%以上
3. 全てのテストが成功している
4. ESLintエラー・警告がゼロ
5. TypeScript型エラーがゼロ
6. API仕様書が整備されている
7. 運用ガイドが整備されている
8. プロフィール取得APIが正常に動作する
9. プロフィール更新APIが正常に動作する
10. プロフィール削除APIが正常に動作する（カスケード削除含む）
11. 認証・認可が正しく機能する
12. バリデーションが正しく機能する
13. エラーハンドリングが適切に実装されている
14. ログが適切に記録される
15. CloudWatchアラームが設定されている
