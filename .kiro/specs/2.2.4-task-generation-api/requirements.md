# 要件定義書

## はじめに

この要件定義書は、アクションから具体的なタスクを自動生成するAPIの実装について定義します。2.2.1で実装したBedrock Lambda関数、2.2.2で実装したサブ目標生成API、2.2.3で実装したアクション生成APIを基盤として、マンダラチャート作成の第3ステップとなるタスク生成機能を提供します。

タスクは1つのアクションに対して複数生成され、各タスクの推定所要時間は30分〜60分程度とします。実行アクションのタスクは全て完了することでアクションが達成され、習慣アクションのタスクは目標達成期間の8割を継続することでアクションが達成されます。

## 要件

### 要件1: タスク生成エンドポイント

**ユーザーストーリー:** ユーザーとして、アクション情報を入力してタスクを自動生成したい。そうすることで、アクション達成のための具体的な作業計画を素早く把握できる。

#### 受入基準

1. WHEN POST /api/ai/generate/tasks エンドポイントにリクエストを送信する THEN タスク生成処理が開始される
2. WHEN リクエストボディにアクションIDが含まれる THEN 必須フィールド（actionId）が検証される
3. WHEN 認証トークンが有効である THEN ユーザーIDが抽出され、リクエストに紐付けられる
4. WHEN タスク生成が成功する THEN 複数のタスクがデータベースに保存される
5. WHEN レスポンスを返す THEN 生成されたタスクの配列とメタデータが返される
6. WHEN エラーが発生する THEN 適切なHTTPステータスコードとエラーメッセージが返される
7. WHEN アクションコンテキストが利用可能である THEN サブ目標・目標情報もプロンプトに含まれる

### 要件2: アクションコンテキスト活用

**ユーザーストーリー:** システム開発者として、アクションだけでなくサブ目標・目標全体のコンテキストを活用したい。そうすることで、より一貫性のあるタスクを生成できる。

#### 受入基準

1. WHEN タスク生成リクエストを処理する THEN アクションの親サブ目標情報がデータベースから取得される
2. WHEN プロンプトを構築する THEN 目標のタイトル、説明、期限、背景が含まれる
3. WHEN プロンプトを構築する THEN サブ目標のタイトル、説明、背景が含まれる
4. WHEN プロンプトを構築する THEN アクションのタイトル、説明、背景、種別が含まれる
5. WHEN ユーザー情報が利用可能である THEN 業種・職種情報がコンテキストとして含まれる

### 要件3: タスク粒度調整機能

**ユーザーストーリー:** ユーザーとして、タスクが適切な粒度（30分〜60分）で生成されてほしい。そうすることで、日々の実行が容易になる。

#### 受入基準

1. WHEN タスクを生成する THEN 各タスクの推定所要時間が30分〜60分になるように調整される
2. WHEN アクションが大きい THEN 複数のタスクに分割される
3. WHEN アクションが小さい THEN 1つのタスクとして生成される
4. WHEN 推定所要時間を算出する THEN AIがタスク内容から推定する
5. WHEN 推定所要時間が不明確である THEN デフォルトで45分が設定される

### 要件4: タスク種別の継承

**ユーザーストーリー:** システム開発者として、タスクの種別がアクションの種別を継承してほしい。そうすることで、適切なリマインド設定が可能になる。

#### 受入基準

1. WHEN 実行アクションからタスクを生成する THEN タスク種別がEXECUTIONに設定される
2. WHEN 習慣アクションからタスクを生成する THEN タスク種別がHABITに設定される
3. WHEN タスクを保存する THEN type（EXECUTION/HABIT）が正しく設定される
4. WHEN タスクの種別を確認する THEN アクションの種別と一致している

### 要件5: タスク優先度設定

**ユーザーストーリー:** ユーザーとして、タスクに優先度が設定されてほしい。そうすることで、どのタスクから着手すべきか判断できる。

#### 受入基準

1. WHEN タスクを生成する THEN 各タスクに優先度（HIGH/MEDIUM/LOW）が設定される
2. WHEN アクションの重要度が高い THEN タスクの優先度がHIGHに設定される
3. WHEN タスクが前提条件となる THEN 優先度がHIGHに設定される
4. WHEN タスクが補助的である THEN 優先度がLOWに設定される
5. WHEN 優先度が不明確である THEN デフォルトでMEDIUMが設定される

### 要件6: タスク依存関係管理

**ユーザーストーリー:** システム開発者として、タスク間の依存関係を管理したい。そうすることで、適切な順序でタスクを実行できる。

#### 受入基準

1. WHEN タスクを生成する THEN タスク間の依存関係が識別される
2. WHEN タスクAがタスクBの前提条件である THEN 依存関係が記録される
3. WHEN 依存関係を表示する THEN ユーザーに分かりやすく提示される
4. WHEN 依存タスクが未完了である THEN 依存先タスクの実行が推奨されない
5. WHEN 循環依存が検出される THEN エラーが記録される

### 要件7: 品質フィルタリング

**ユーザーストーリー:** システム開発者として、生成されたタスクの品質を評価したい。そうすることで、低品質な結果を検出し、再生成を促すことができる。

#### 受入基準

1. WHEN タスクが生成される THEN 最低1個以上のタスクが生成されていることが検証される
2. WHEN タスクが生成される THEN 各タスクのタイトルが50文字以内であることが検証される
3. WHEN タスクが生成される THEN 各タスクの説明が200文字以内であることが検証される
4. WHEN タスクが生成される THEN 推定所要時間が15分〜120分の範囲内であることが検証される
5. WHEN タスクの説明が不十分である（20文字未満） THEN 警告ログが記録される
6. WHEN タスクが抽象的すぎる THEN 警告ログが記録される
7. WHEN 品質基準を満たさない THEN エラーレスポンスが返され、再試行が促される

### 要件8: データベース統合

**ユーザーストーリー:** システム開発者として、生成されたタスクをデータベースに永続化したい。そうすることで、ユーザーが後から確認・編集できる。

#### 受入基準

1. WHEN タスク生成が成功する THEN Actionレコードが更新される
2. WHEN タスクを保存する THEN 複数のTaskレコードがトランザクション内で作成される
3. WHEN データベースエラーが発生する THEN トランザクションがロールバックされる
4. WHEN タスクを保存する THEN actionIdとの外部キー関係が正しく設定される
5. WHEN タスクを保存する THEN type（EXECUTION/HABIT）が正しく設定される
6. WHEN タスクを保存する THEN status（NOT_STARTED）が初期値として設定される
7. WHEN 既存のタスクが存在する THEN 既存データを削除してから新規作成される

### 要件9: エラーハンドリングと再試行

**ユーザーストーリー:** ユーザーとして、AI生成が失敗した場合に適切なフィードバックを受け取りたい。そうすることで、問題を理解し、適切に対処できる。

#### 受入基準

1. WHEN Bedrock APIがスロットリングエラーを返す THEN 自動的にリトライが実行される
2. WHEN リトライが3回失敗する THEN ユーザーフレンドリーなエラーメッセージが返される
3. WHEN JSON解析エラーが発生する THEN 「AI生成結果の解析に失敗しました」というメッセージが返される
4. WHEN データベースエラーが発生する THEN 「データの保存に失敗しました」というメッセージが返される
5. WHEN タイムアウトが発生する THEN 「処理時間が長すぎます。もう一度お試しください」というメッセージが返される
6. WHEN エラーが発生する THEN エラー詳細がCloudWatch Logsに記録される
7. WHEN エラーが発生する THEN ユーザーには機密情報を含まないエラーメッセージが返される

### 要件10: パフォーマンスとコスト管理

**ユーザーストーリー:** システム管理者として、API呼び出しのパフォーマンスとコストを管理したい。そうすることで、予算内で安定したサービスを提供できる。

#### 受入基準

1. WHEN タスク生成リクエストを処理する THEN 95パーセンタイルで30秒以内に完了する
2. WHEN 同時リクエストが発生する THEN Lambda同時実行数制限（10）が適用される
3. WHEN トークン使用量を記録する THEN CloudWatchカスタムメトリクスに送信される
4. WHEN 推定コストを計算する THEN ログに記録される
5. WHEN 月次コスト上限に近づく THEN アラートが発行される
6. WHEN プロンプトを最適化する THEN 不要なトークンが削減される

### 要件11: セキュリティとアクセス制御

**ユーザーストーリー:** システム管理者として、APIへの不正アクセスを防止したい。そうすることで、システムとユーザーデータを保護できる。

#### 受入基準

1. WHEN APIリクエストを受信する THEN JWT認証トークンが検証される
2. WHEN 認証トークンが無効である THEN 401 Unauthorizedが返される
3. WHEN ユーザーが他人のアクションを操作しようとする THEN 403 Forbiddenが返される
4. WHEN レート制限を超える THEN 429 Too Many Requestsが返される
5. WHEN プロンプトインジェクションを検出する THEN リクエストが拒否される
6. WHEN 機密情報をログに記録する THEN マスキングが適用される

### 要件12: 監視とログ

**ユーザーストーリー:** システム管理者として、API呼び出しの状況を監視したい。そうすることで、問題を早期に発見し、対処できる。

#### 受入基準

1. WHEN APIリクエストを処理する THEN 構造化ログがCloudWatch Logsに出力される
2. WHEN ログを出力する THEN requestId、userId、actionId、処理時間が含まれる
3. WHEN タスク生成が成功する THEN 成功メトリクスがCloudWatchに送信される
4. WHEN タスク生成が失敗する THEN 失敗メトリクスとエラー種別がCloudWatchに送信される
5. WHEN 処理時間が閾値を超える THEN アラートが発行される
6. WHEN エラー率が閾値を超える THEN アラートが発行される

## 非機能要件

### パフォーマンス

- API応答時間: 95パーセンタイルで30秒以内
- スループット: 10リクエスト/秒（初期設定）
- データベース接続: 接続プール使用

### 可用性

- API成功率: 99%以上
- 自動リトライによる復旧
- エラー時の適切なフォールバック

### スケーラビリティ

- Lambda同時実行数: 10（初期）→ 100（段階的拡張）
- データベース接続数: 適切な接続プール設定

### セキュリティ

- JWT認証必須
- プロンプトインジェクション対策
- レート制限: 10リクエスト/分/ユーザー
- 入力サニタイゼーション

### 監視

- CloudWatch Logsへの構造化ログ出力
- CloudWatch Metricsへのカスタムメトリクス送信
- エラー率、レスポンス時間、コストの監視
- アラート設定（エラー率、レスポンス時間）

## 制約事項

- Amazon Bedrock Nova Microモデルの利用制限に準拠
- Lambda関数の実行時間制限（最大15分）
- データベース接続数の制限
- 月次コスト予算の制約
- 1つのアクションに対して最低1個以上のタスクを生成
- 各タスクの推定所要時間は30分〜60分を目安とする

## 依存関係

- 2.2.1 Bedrock Lambda関数（完了済み）
- 2.2.2 サブ目標生成API（完了済み）
- 2.2.3 アクション生成API（完了済み）
- 1.4.2 Prismaスキーマ定義（完了済み）
- 1.3.2 JWT認証ミドルウェア（完了済み）
- AWS SDK for JavaScript v3
- Prismaクライアント
- Zodバリデーションライブラリ

## 成功基準

1. タスク生成APIが正常に動作する
2. 全ての受入基準を満たす
3. ユニットテストカバレッジが80%以上
4. 統合テストが全て成功する
5. パフォーマンス要件を満たす
6. セキュリティ要件を満たす
7. ドキュメントが整備される
8. フロントエンドとの統合が完了する

## インターフェース定義

### リクエスト形式

```typescript
POST /api/ai/generate/tasks
Content-Type: application/json
Authorization: Bearer <JWT_TOKEN>

{
  "actionId": "uuid", // アクションID（必須）
  "regenerate": false  // 既存のタスクを再生成する場合true（オプション）
}
```

### レスポンス形式（成功）

```typescript
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "data": {
    "actionId": "uuid",
    "tasks": [
      {
        "id": "uuid",
        "title": "TypeScript公式ドキュメントの基礎編を読む",
        "description": "TypeScript公式ドキュメントの基礎編（型システム、インターフェース、クラス）を読み、サンプルコードを実際に動かして理解を深める",
        "type": "EXECUTION",
        "status": "NOT_STARTED",
        "estimatedMinutes": 45,
        "priority": "HIGH",
        "dependencies": [],
        "createdAt": "2025-10-10T10:00:00Z",
        "updatedAt": "2025-10-10T10:00:00Z"
      },
      {
        "id": "uuid",
        "title": "TypeScriptの型システムを実践する",
        "description": "学んだ型システムの知識を使って、簡単なTypeScriptプログラムを作成し、型の恩恵を体感する",
        "type": "EXECUTION",
        "status": "NOT_STARTED",
        "estimatedMinutes": 60,
        "priority": "MEDIUM",
        "dependencies": ["前のタスクのID"],
        "createdAt": "2025-10-10T10:00:00Z",
        "updatedAt": "2025-10-10T10:00:00Z"
      }
      // ... 追加のタスク
    ]
  },
  "metadata": {
    "generatedAt": "2025-10-10T10:00:00Z",
    "tokensUsed": 2500,
    "estimatedCost": 0.00038,
    "actionContext": {
      "goalTitle": "TypeScriptのエキスパートになる",
      "subGoalTitle": "TypeScriptの基礎文法を習得する",
      "actionTitle": "TypeScript公式ドキュメントを読む",
      "actionType": "EXECUTION"
    },
    "taskCount": 3,
    "totalEstimatedMinutes": 150
  }
}
```

### レスポンス形式（エラー）

```typescript
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力データが不正です",
    "details": [
      {
        "field": "actionId",
        "message": "アクションIDは必須です"
      }
    ]
  }
}
```

```typescript
HTTP/1.1 404 Not Found
Content-Type: application/json

{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "指定されたアクションが見つかりません"
  }
}
```

```typescript
HTTP/1.1 403 Forbidden
Content-Type: application/json

{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "このアクションにアクセスする権限がありません"
  }
}
```
