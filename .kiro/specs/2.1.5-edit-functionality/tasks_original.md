# 実装タスクリスト

## 概要

マンダラチャート編集機能の実装タスクです。インライン編集、モーダル編集、変更履歴管理、編集権限制御、編集競合回避機能を段階的に実装します。

## タスク

- [ ] 1. データベーススキーマ拡張
  - 変更履歴テーブルの追加
  - Prismaスキーマ更新
  - マイグレーション作成・実行
  - _要件: 5.1, 5.2, 5.3_

- [ ] 2. バックエンドAPI実装（更新系）
  - [ ] 2.1 目標更新APIの実装
    - PUT /api/goals/:goalId エンドポイント作成
    - Zodバリデーションスキーマ実装
    - 楽観的ロック処理実装
    - 権限チェック実装
    - _要件: 1.5, 2.3, 4.3, 5.2, 5.5_
  
  - [ ] 2.2 サブ目標更新APIの実装
    - PUT /api/subgoals/:subGoalId エンドポイント作成
    - Zodバリデーションスキーマ実装
    - 楽観的ロック処理実装
    - 権限チェック実装
    - _要件: 1.5, 2.3, 4.3, 5.2, 5.5_
  
  - [ ] 2.3 アクション更新APIの実装
    - PUT /api/actions/:actionId エンドポイント作成
    - Zodバリデーションスキーマ実装
    - 楽観的ロック処理実装
    - 権限チェック実装
    - _要件: 1.5, 2.3, 4.3, 5.2, 5.5_

- [ ] 3. バックエンドAPI実装（履歴系）
  - [ ] 3.1 変更履歴記録機能の実装
    - 更新時の履歴記録ロジック実装
    - 差分計算機能実装
    - _要件: 3.1_
  
  - [ ] 3.2 変更履歴取得APIの実装
    - GET /api/goals/:goalId/history エンドポイント作成
    - GET /api/subgoals/:subGoalId/history エンドポイント作成
    - GET /api/actions/:actionId/history エンドポイント作成
    - ページネーション実装
    - _要件: 3.2, 3.3_
  
  - [ ] 3.3 ロールバック機能の実装（管理者のみ）
    - POST /api/goals/:goalId/rollback エンドポイント作成
    - 管理者権限チェック実装
    - _要件: 3.5_

- [ ] 4. InlineEditorコンポーネント実装
  - [ ] 4.1 基本コンポーネント作成
    - InlineEditor.tsxファイル作成
    - Props定義とState管理実装
    - 編集モード切替実装
    - _要件: 1.1_
  
  - [ ] 4.2 バリデーション機能実装
    - リアルタイムバリデーション実装
    - エラーメッセージ表示実装
    - _要件: 1.4_
  
  - [ ] 4.3 保存・キャンセル処理実装
    - Enter/外側クリックでの保存処理
    - Escキーでのキャンセル処理
    - 楽観的UI更新実装
    - _要件: 1.2, 1.3, 1.5_
  
  - [ ] 4.4 キーボード操作対応
    - Tab/Shift+Tabでのフォーカス移動
    - ARIA属性設定
    - _要件: アクセシビリティ_

- [ ] 5. MandalaCellコンポーネント拡張
  - [ ] 5.1 編集モード統合
    - InlineEditorの統合
    - 編集ボタンの追加
    - ダブルクリックでの編集開始
    - _要件: 1.1, 2.1_
  
  - [ ] 5.2 権限制御の実装
    - 編集可能状態の判定
    - 編集ボタンの表示/非表示制御
    - _要件: 4.1, 4.2, 4.4_

- [ ] 6. EditModalコンポーネント実装
  - [ ] 6.1 基本モーダル構造作成
    - EditModal.tsxファイル作成
    - モーダルレイアウト実装
    - 開閉アニメーション実装
    - _要件: 2.1, 2.2_
  
  - [ ] 6.2 フォームフィールド実装
    - 目標編集フォーム実装
    - サブ目標編集フォーム実装
    - アクション編集フォーム実装
    - React Hook Form統合
    - _要件: 2.2_
  
  - [ ] 6.3 バリデーションとエラー表示
    - フォームバリデーション実装
    - エラーメッセージ表示実装
    - _要件: 2.3_
  
  - [ ] 6.4 保存・キャンセル処理
    - 保存ボタン処理実装
    - キャンセルボタン処理実装
    - モーダル外クリック処理実装
    - _要件: 2.4, 2.5_

- [ ] 7. ConflictDialogコンポーネント実装
  - [ ] 7.1 競合検出ダイアログ作成
    - ConflictDialog.tsxファイル作成
    - 競合情報表示実装
    - 差分表示実装
    - _要件: 5.3_
  
  - [ ] 7.2 ユーザー選択処理実装
    - 最新データ取得ボタン実装
    - 変更破棄ボタン実装
    - _要件: 5.4_

- [ ] 8. HistoryPanelコンポーネント実装
  - [ ] 8.1 履歴パネル基本構造作成
    - HistoryPanel.tsxファイル作成
    - 履歴一覧表示実装
    - ページネーション実装
    - _要件: 3.2_
  
  - [ ] 8.2 差分表示機能実装
    - 変更内容の差分表示実装
    - ハイライト表示実装
    - _要件: 3.3_
  
  - [ ] 8.3 履歴詳細表示実装
    - 履歴エントリクリック処理
    - 詳細モーダル表示実装
    - _要件: 3.4_
  
  - [ ] 8.4 ロールバック機能実装（管理者のみ）
    - ロールバックボタン実装
    - 確認ダイアログ実装
    - _要件: 3.5_

- [ ] 9. 状態管理とAPI統合
  - [ ] 9.1 編集状態管理の実装
    - 編集中状態の管理
    - 楽観的更新の実装
    - エラー時のロールバック実装
    - _要件: 1.5, 2.5_
  
  - [ ] 9.2 API呼び出しフック作成
    - useUpdateGoal フック実装
    - useUpdateSubGoal フック実装
    - useUpdateAction フック実装
    - useHistory フック実装
    - _要件: 全般_
  
  - [ ] 9.3 競合検出処理の統合
    - 409エラーハンドリング実装
    - ConflictDialog表示処理実装
    - _要件: 5.1, 5.2, 5.3_

- [ ] 10. セキュリティ対策実装
  - [ ] 10.1 入力サニタイゼーション実装
    - DOMPurify統合
    - サニタイゼーション関数実装
    - _要件: セキュリティ_
  
  - [ ] 10.2 権限チェック強化
    - フロントエンド権限チェック実装
    - バックエンド権限チェック実装
    - _要件: 4.1, 4.2, 4.3_

- [ ] 11. スタイリング実装
  - [ ] 11.1 InlineEditorスタイル実装
    - 編集モード時のスタイル
    - エラー表示スタイル
    - _要件: ユーザビリティ_
  
  - [ ] 11.2 EditModalスタイル実装
    - モーダルレイアウトスタイル
    - フォームスタイル
    - レスポンシブ対応
    - _要件: ユーザビリティ_
  
  - [ ] 11.3 HistoryPanelスタイル実装
    - 履歴一覧スタイル
    - 差分表示スタイル
    - _要件: ユーザビリティ_
  
  - [ ] 11.4 ConflictDialogスタイル実装
    - ダイアログスタイル
    - 差分ハイライトスタイル
    - _要件: ユーザビリティ_

- [ ]* 12. ユニットテスト実装
  - [ ]* 12.1 InlineEditorテスト作成
    - 編集モード切替テスト
    - バリデーションテスト
    - 保存/キャンセル処理テスト
    - キーボード操作テスト
  
  - [ ]* 12.2 EditModalテスト作成
    - フォームバリデーションテスト
    - 保存処理テスト
    - キャンセル処理テスト
  
  - [ ]* 12.3 ConflictDialogテスト作成
    - 競合検出テスト
    - ユーザー選択処理テスト
  
  - [ ]* 12.4 HistoryPanelテスト作成
    - 履歴表示テスト
    - 差分表示テスト
    - ロールバック処理テスト
  
  - [ ]* 12.5 バックエンドAPIテスト作成
    - 更新APIテスト
    - 楽観的ロックテスト
    - 権限チェックテスト
    - 履歴記録テスト

- [ ]* 13. 統合テスト実装
  - [ ]* 13.1 インライン編集フローテスト
    - セルクリック → 編集 → 保存 → 反映確認
  
  - [ ]* 13.2 モーダル編集フローテスト
    - 編集ボタン → モーダル表示 → 編集 → 保存 → 反映確認
  
  - [ ]* 13.3 編集競合フローテスト
    - 同時編集 → 競合検出 → 解決
  
  - [ ]* 13.4 変更履歴フローテスト
    - 履歴ボタン → 履歴表示 → 差分確認 → ロールバック

- [ ]* 14. E2Eテスト実装
  - [ ]* 14.1 インライン編集E2Eテスト
    - Playwrightテスト作成
    - 複数ブラウザでの動作確認
  
  - [ ]* 14.2 モーダル編集E2Eテスト
    - Playwrightテスト作成
    - フォーム入力テスト
  
  - [ ]* 14.3 編集競合E2Eテスト
    - 複数タブでの同時編集テスト
  
  - [ ]* 14.4 変更履歴E2Eテスト
    - 履歴表示・ロールバックテスト

- [ ] 15. ドキュメント作成
  - 編集機能の使い方ドキュメント作成
  - API仕様書更新
  - コンポーネントドキュメント作成
  - _要件: 全般_

- [ ] 16. パフォーマンス最適化
  - [ ] 16.1 楽観的UI更新の最適化
    - レンダリング最適化
    - メモ化実装
  
  - [ ] 16.2 デバウンス処理実装
    - バリデーションのデバウンス
    - API呼び出しのデバウンス

- [ ] 17. アクセシビリティ対応
  - [ ] 17.1 キーボード操作の完全対応
    - Tab/Shift+Tab対応確認
    - Enter/Esc対応確認
  
  - [ ] 17.2 ARIA属性の設定
    - 全コンポーネントのARIA属性確認
    - スクリーンリーダーテスト
  
  - [ ] 17.3 フォーカス管理の実装
    - フォーカストラップ実装
    - フォーカス復帰実装

- [ ] 18. 最終検証とコード品質確認
  - npm run formatの実行
  - npm run lintの実行（エラー・警告ゼロ確認）
  - 全テストの実行と成功確認
  - コードレビュー実施
  - _要件: 全般_

## 注意事項

- タスク12〜14（テスト関連）は「*」マークが付いており、オプションです
- 各タスクは独立して実装・テスト可能です
- 実装優先順位に従って段階的に進めてください
- 各タスク完了後は必ずテストを実行してください
