# 要件定義書

## はじめに

マンダラチャートの編集機能を実装します。ユーザーが目標、サブ目標、アクションを柔軟に編集できるようにし、変更履歴の管理と編集競合の回避を実現します。

## 要件

### 要件1: インライン編集機能

**ユーザーストーリー:** マンダラチャート表示画面のユーザーとして、セルを直接クリックして内容を編集したい。そうすることで、別画面に遷移せずに素早く修正できる。

#### 受入基準

1. WHEN ユーザーがマンダラチャートのセルをクリック THEN そのセルが編集モードになり、テキスト入力が可能になる SHALL
2. WHEN ユーザーが編集中のセルの外側をクリック OR Enterキーを押下 THEN 変更が保存され、編集モードが終了する SHALL
3. WHEN ユーザーがEscキーを押下 THEN 変更が破棄され、元の内容に戻る SHALL
4. WHEN ユーザーが編集中に無効な入力（空文字、文字数超過など）を行う THEN バリデーションエラーが表示され、保存できない SHALL
5. WHEN インライン編集で保存が成功 THEN APIを呼び出してデータベースを更新し、UIに反映する SHALL

### 要件2: モーダル編集機能

**ユーザーストーリー:** マンダラチャートのユーザーとして、詳細な編集が必要な場合はモーダルで編集したい。そうすることで、タイトル、説明、背景、制約事項などを一度に編集できる。

#### 受入基準

1. WHEN ユーザーがセルの編集ボタン（または右クリックメニュー）をクリック THEN 詳細編集モーダルが表示される SHALL
2. WHEN モーダルが表示される THEN 目標/サブ目標/アクションの全フィールド（タイトル、説明、背景、制約事項）が編集可能な状態で表示される SHALL
3. WHEN ユーザーがモーダル内で「保存」ボタンをクリック THEN バリデーションを実行し、成功時にAPIを呼び出してデータを更新する SHALL
4. WHEN ユーザーがモーダル内で「キャンセル」ボタンをクリック OR モーダル外をクリック THEN 変更を破棄してモーダルを閉じる SHALL
5. WHEN モーダルでの保存が成功 THEN マンダラチャート表示を更新し、成功メッセージを表示する SHALL

### 要件3: 変更履歴管理

**ユーザーストーリー:** マンダラチャートのユーザーとして、過去の編集履歴を確認したい。そうすることで、いつ誰が何を変更したかを追跡できる。

#### 受入基準

1. WHEN ユーザーが目標/サブ目標/アクションを編集して保存 THEN 変更履歴がデータベースに記録される SHALL
2. WHEN ユーザーが「履歴」ボタンをクリック THEN 変更履歴一覧がモーダルまたはサイドパネルで表示される SHALL
3. WHEN 変更履歴が表示される THEN 各履歴エントリに変更日時、変更者、変更内容（差分）が含まれる SHALL
4. WHEN ユーザーが履歴エントリをクリック THEN その時点の内容が表示される SHALL
5. IF 管理者権限を持つユーザー THEN 特定の履歴バージョンに戻す（ロールバック）機能が利用可能である SHALL

### 要件4: 編集権限制御

**ユーザーストーリー:** マンダラチャートの所有者として、自分の目標は自分だけが編集できるようにしたい。そうすることで、意図しない変更を防げる。

#### 受入基準

1. WHEN ユーザーが自分が作成した目標のマンダラチャートを表示 THEN 編集機能が有効になる SHALL
2. WHEN ユーザーが他人が作成した目標のマンダラチャートを表示 THEN 編集機能が無効になり、読み取り専用モードで表示される SHALL
3. WHEN 権限のないユーザーが編集APIを呼び出し THEN 403 Forbiddenエラーが返される SHALL
4. WHEN 編集権限がない場合 THEN 編集ボタンやインライン編集機能が非表示または無効化される SHALL
5. IF 将来的に共有機能が実装される場合 THEN 共有設定に基づいて編集権限を制御できる SHALL

### 要件5: 編集競合回避機能

**ユーザーストーリー:** マンダラチャートのユーザーとして、同時編集による競合を避けたい。そうすることで、他のユーザーの変更を上書きしてしまうことを防げる。

#### 受入基準

1. WHEN ユーザーが編集を開始 THEN 現在のデータバージョン（タイムスタンプまたはバージョン番号）を取得する SHALL
2. WHEN ユーザーが保存を実行 THEN サーバー側で現在のバージョンと比較し、変更がある場合は競合エラーを返す SHALL
3. WHEN 編集競合が検出される THEN ユーザーに競合を通知し、最新データを表示する SHALL
4. WHEN 競合通知が表示される THEN ユーザーは「最新データを取得して再編集」または「変更を破棄」を選択できる SHALL
5. WHEN 楽観的ロックを使用 THEN データベースのupdated_atフィールドを利用してバージョン管理を行う SHALL

## 非機能要件

### パフォーマンス

- インライン編集の保存は1秒以内に完了する
- モーダル編集の保存は2秒以内に完了する
- 変更履歴の取得は1秒以内に完了する

### ユーザビリティ

- インライン編集は直感的で、クリック1回で編集モードに入れる
- モーダル編集は全フィールドが見やすく配置されている
- 編集中の状態が視覚的に明確である（ハイライト、ボーダーなど）

### セキュリティ

- 編集APIは認証必須である
- 編集権限はサーバー側で厳密にチェックされる
- XSS対策として入力値はサニタイズされる

### アクセシビリティ

- キーボード操作のみで編集が完結できる
- スクリーンリーダーで編集状態が読み上げられる
- フォーカス管理が適切に行われる
