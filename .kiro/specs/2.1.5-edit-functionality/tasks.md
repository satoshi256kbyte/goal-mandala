# 実装タスクリスト

## 概要

マンダラチャート編集機能の実装タスクです。テストファーストの原則に基づき、各機能の実装前にテストを作成し、段階的に機能を実装します。

## タスク

- [x] 1. データベーススキーマ拡張とテスト
  - [x] 1.1 変更履歴テーブルのスキーマ設計
    - Prismaスキーマに ChangeHistory モデル追加
    - 既存モデルへの updated_at フィールド確認
    - _要件: 5.1, 5.2, 5.3_
  
  - [x] 1.2 マイグレーションテスト作成
    - マイグレーション実行テスト作成
    - データ整合性テスト作成
  
  - [x] 1.3 マイグレーション実行
    - マイグレーションファイル生成
    - ローカル環境でマイグレーション実行
    - テスト実行と確認

- [x] 2. バックエンドAPI実装（更新系）- テストファースト
  - [x] 2.1 目標更新APIのテスト作成
    - 正常系テスト（更新成功）
    - バリデーションエラーテスト
    - 楽観的ロック競合テスト
    - 権限エラーテスト
    - _要件: 1.5, 2.3, 4.3, 5.2, 5.5_
  
  - [x] 2.2 目標更新APIの実装
    - PUT /api/goals/:goalId エンドポイント作成
    - Zodバリデーションスキーマ実装
    - 楽観的ロック処理実装
    - 権限チェック実装
    - テスト実行と確認
  
  - [x] 2.3 サブ目標更新APIのテスト作成
    - 正常系テスト（更新成功）
    - バリデーションエラーテスト
    - 楽観的ロック競合テスト
    - 権限エラーテスト
  
  - [x] 2.4 サブ目標更新APIの実装
    - PUT /api/subgoals/:subGoalId エンドポイント作成
    - Zodバリデーションスキーマ実装
    - 楽観的ロック処理実装
    - 権限チェック実装
    - テスト実行と確認
  
  - [x] 2.5 アクション更新APIのテスト作成
    - 正常系テスト（更新成功）
    - バリデーションエラーテスト
    - 楽観的ロック競合テスト
    - 権限エラーテスト
  
  - [x] 2.6 アクション更新APIの実装
    - PUT /api/actions/:actionId エンドポイント作成
    - Zodバリデーションスキーマ実装
    - 楽観的ロック処理実装
    - 権限チェック実装
    - テスト実行と確認

- [x] 3. バックエンドAPI実装（履歴系）- テストファースト
  - [x] 3.1 変更履歴記録機能のテスト作成
    - 履歴記録テスト
    - 差分計算テスト
    - _要件: 3.1_
  
  - [x] 3.2 変更履歴記録機能の実装
    - 更新時の履歴記録ロジック実装
    - 差分計算機能実装
    - テスト実行と確認
  
  - [x] 3.3 変更履歴取得APIのテスト作成
    - 履歴一覧取得テスト
    - ページネーションテスト
    - _要件: 3.2, 3.3_
  
  - [x] 3.4 変更履歴取得APIの実装
    - GET /api/goals/:goalId/history エンドポイント作成
    - GET /api/subgoals/:subGoalId/history エンドポイント作成
    - GET /api/actions/:actionId/history エンドポイント作成
    - ページネーション実装
    - テスト実行と確認
  
  - [x] 3.5 ロールバック機能のテスト作成（管理者のみ）
    - ロールバック成功テスト
    - 権限エラーテスト
    - _要件: 3.5_
  
  - [x] 3.6 ロールバック機能の実装（管理者のみ）
    - POST /api/goals/:goalId/rollback エンドポイント作成
    - 管理者権限チェック実装
    - テスト実行と確認

- [x] 4. InlineEditorコンポーネント実装 - テストファースト
  - [x] 4.1 InlineEditorコンポーネントのテスト作成
    - 編集モード切替テスト
    - バリデーションテスト
    - 保存/キャンセル処理テスト
    - キーボード操作テスト（Enter, Esc, Tab）
    - _要件: 1.1, 1.2, 1.3, 1.4_
  
  - [x] 4.2 InlineEditorコンポーネントの実装
    - InlineEditor.tsxファイル作成
    - Props定義とState管理実装
    - 編集モード切替実装
    - リアルタイムバリデーション実装
    - エラーメッセージ表示実装
    - Enter/外側クリックでの保存処理
    - Escキーでのキャンセル処理
    - 楽観的UI更新実装
    - Tab/Shift+Tabでのフォーカス移動
    - ARIA属性設定
    - テスト実行と確認

- [x] 5. MandalaCellコンポーネント拡張 - テストファースト
  - [x] 5.1 MandalaCellコンポーネント拡張のテスト作成
    - InlineEditor統合テスト
    - 編集ボタン表示テスト
    - ダブルクリック編集開始テスト
    - 権限制御テスト
    - _要件: 1.1, 2.1, 4.1, 4.2, 4.4_
  
  - [x] 5.2 MandalaCellコンポーネント拡張の実装
    - InlineEditorの統合
    - 編集ボタンの追加
    - ダブルクリックでの編集開始
    - 編集可能状態の判定
    - 編集ボタンの表示/非表示制御
    - テスト実行と確認

- [x] 6. EditModalコンポーネント実装 - テストファースト
  - [x] 6.1 EditModalコンポーネントのテスト作成
    - モーダル開閉テスト
    - フォームバリデーションテスト
    - 保存処理テスト
    - キャンセル処理テスト
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [x] 6.2 EditModalコンポーネントの実装
    - EditModal.tsxファイル作成
    - モーダルレイアウト実装
    - 開閉アニメーション実装
    - 目標編集フォーム実装
    - サブ目標編集フォーム実装
    - アクション編集フォーム実装
    - React Hook Form統合
    - フォームバリデーション実装
    - エラーメッセージ表示実装
    - 保存ボタン処理実装
    - キャンセルボタン処理実装
    - モーダル外クリック処理実装
    - テスト実行と確認

- [x] 7. ConflictDialogコンポーネント実装 - テストファースト
  - [x] 7.1 ConflictDialogコンポーネントのテスト作成
    - 競合検出表示テスト
    - 差分表示テスト
    - ユーザー選択処理テスト
    - _要件: 5.3, 5.4_
  
  - [x] 7.2 ConflictDialogコンポーネントの実装
    - ConflictDialog.tsxファイル作成
    - 競合情報表示実装
    - 差分表示実装
    - 最新データ取得ボタン実装
    - 変更破棄ボタン実装
    - テスト実行と確認

- [x] 8. HistoryPanelコンポーネント実装 - テストファースト
  - [x] 8.1 HistoryPanelコンポーネントのテスト作成
    - 履歴一覧表示テスト
    - ページネーションテスト
    - 差分表示テスト
    - 履歴詳細表示テスト
    - ロールバック処理テスト（管理者のみ）
    - _要件: 3.2, 3.3, 3.4, 3.5_
  
  - [x] 8.2 HistoryPanelコンポーネントの実装
    - HistoryPanel.tsxファイル作成
    - 履歴一覧表示実装
    - ページネーション実装
    - 変更内容の差分表示実装
    - ハイライト表示実装
    - 履歴エントリクリック処理
    - 詳細モーダル表示実装
    - ロールバックボタン実装
    - 確認ダイアログ実装
    - テスト実行と確認

- [x] 9. 状態管理とAPI統合 - テストファースト
  - [x] 9.1 API呼び出しフックのテスト作成
    - useUpdateGoal フックテスト
    - useUpdateSubGoal フックテスト
    - useUpdateAction フックテスト
    - useHistory フックテスト
    - 楽観的更新テスト
    - エラー時のロールバックテスト
    - 競合検出処理テスト
    - _要件: 1.5, 2.5, 5.1, 5.2, 5.3_
  
  - [x] 9.2 API呼び出しフックの実装
    - useUpdateGoal フック実装
    - useUpdateSubGoal フック実装
    - useUpdateAction フック実装
    - useHistory フック実装
    - 編集中状態の管理
    - 楽観的更新の実装
    - エラー時のロールバック実装
    - 409エラーハンドリング実装
    - ConflictDialog表示処理実装
    - テスト実行と確認

- [x] 10. セキュリティ対策実装 - テストファースト
  - [x] 10.1 セキュリティ機能のテスト作成
    - 入力サニタイゼーションテスト
    - XSS対策テスト
    - 権限チェックテスト（フロントエンド）
    - 権限チェックテスト（バックエンド）
    - _要件: セキュリティ, 4.1, 4.2, 4.3_
  
  - [x] 10.2 セキュリティ機能の実装
    - DOMPurify統合
    - サニタイゼーション関数実装
    - フロントエンド権限チェック実装
    - バックエンド権限チェック実装
    - テスト実行と確認

- [x] 11. スタイリング実装
  - [x] 11.1 InlineEditorスタイル実装
    - 編集モード時のスタイル
    - エラー表示スタイル
    - フォーカススタイル
    - _要件: ユーザビリティ_
  
  - [x] 11.2 EditModalスタイル実装
    - モーダルレイアウトスタイル
    - フォームスタイル
    - レスポンシブ対応
    - _要件: ユーザビリティ_
  
  - [x] 11.3 HistoryPanelスタイル実装
    - 履歴一覧スタイル
    - 差分表示スタイル
    - _要件: ユーザビリティ_
  
  - [x] 11.4 ConflictDialogスタイル実装
    - ダイアログスタイル
    - 差分ハイライトスタイル
    - _要件: ユーザビリティ_

- [x] 12. 統合テスト実装
  - [x] 12.1 インライン編集フローテスト作成
    - セルクリック → 編集 → 保存 → 反映確認
    - エラーケーステスト
  
  - [x] 12.2 モーダル編集フローテスト作成
    - 編集ボタン → モーダル表示 → 編集 → 保存 → 反映確認
    - エラーケーステスト
  
  - [x] 12.3 編集競合フローテスト作成
    - 同時編集 → 競合検出 → 解決
  
  - [x] 12.4 変更履歴フローテスト作成
    - 履歴ボタン → 履歴表示 → 差分確認 → ロールバック
  
  - [x] 12.5 統合テスト実行と確認
    - 全統合テスト実行
    - 失敗ケースの修正

- [x] 13. E2Eテスト実装（オプション）
  - [x] 13.1 インライン編集E2Eテスト作成
    - Playwrightテスト作成
    - 複数ブラウザでの動作確認
  
  - [x] 13.2 モーダル編集E2Eテスト作成
    - Playwrightテスト作成
    - フォーム入力テスト
  
  - [x] 13.3 編集競合E2Eテスト作成
    - 複数タブでの同時編集テスト
  
  - [x] 13.4 変更履歴E2Eテスト作成
    - 履歴表示・ロールバックテスト
  
  - [x] 13.5 E2Eテスト実行と確認
    - 全E2Eテスト実行
    - 失敗ケースの修正

- [x] 14. パフォーマンス最適化
  - [x] 14.1 楽観的UI更新の最適化
    - レンダリング最適化
    - メモ化実装
    - パフォーマンステスト実行
  
  - [x] 14.2 デバウンス処理実装
    - バリデーションのデバウンス
    - API呼び出しのデバウンス
    - パフォーマンステスト実行

- [x] 15. アクセシビリティ対応
  - [x] 15.1 キーボード操作の完全対応
    - Tab/Shift+Tab対応確認
    - Enter/Esc対応確認
    - キーボード操作テスト実行
  
  - [x] 15.2 ARIA属性の設定
    - 全コンポーネントのARIA属性確認
    - スクリーンリーダーテスト実行
  
  - [x] 15.3 フォーカス管理の実装
    - フォーカストラップ実装
    - フォーカス復帰実装
    - フォーカス管理テスト実行

- [x] 16. ドキュメント作成
  - [x] 編集機能の使い方ドキュメント作成
  - [x] API仕様書更新
  - [x] コンポーネントドキュメント作成
  - _要件: 全般_

- [x] 17. 最終検証とコード品質確認
  - [x] npm run formatの実行
  - [x] npm run lintの実行（エラー・警告ゼロ確認）
  - [x] 全テストの実行と成功確認
  - [x] コードレビュー実施
  - _要件: 全般_

## テストファーストの実装フロー

各機能の実装は以下の順序で進めます：

1. **テスト作成** - 期待する動作を定義するテストを先に作成
2. **実装** - テストが通るように機能を実装
3. **テスト実行** - 作成したテストを実行して動作確認
4. **リファクタリング** - テストが通る状態を維持しながらコード改善

## 注意事項

- タスク13（E2Eテスト）は「*」マークが付いており、オプションです
- 各タスクは必ずテストを先に作成してから実装を行ってください
- テストが失敗した場合は、実装を修正してテストを通してください
- 各タスク完了後は必ず全テストを実行して、既存機能が壊れていないことを確認してください
