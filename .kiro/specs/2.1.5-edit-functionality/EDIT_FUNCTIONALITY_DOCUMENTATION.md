# マンダラチャート編集機能ドキュメント

## 概要

マンダラチャート編集機能は、ユーザーが目標、サブ目標、アクションを柔軟に編集できる機能です。インライン編集、モーダル編集、変更履歴管理、競合解決などの機能を提供します。

## 主要機能

### 1. インライン編集

マンダラチャートのセル上で直接テキストを編集できる機能です。

#### 使い方

1. **編集開始**
   - セルをダブルクリック
   - または編集ボタンをクリック

2. **編集中**
   - テキストフィールドに直接入力
   - リアルタイムバリデーション
   - 文字数制限の表示

3. **保存**
   - Enterキーを押す
   - または外側をクリック

4. **キャンセル**
   - Escキーを押す

#### キーボードショートカット

- `Enter`: 保存
- `Esc`: キャンセル
- `Tab`: 次のフィールドへ移動
- `Shift+Tab`: 前のフィールドへ移動

### 2. モーダル編集

詳細な編集が必要な場合に使用するモーダルダイアログです。

#### 使い方

1. **モーダルを開く**
   - セルの編集ボタンをクリック
   - または右クリックメニューから「詳細編集」を選択

2. **編集**
   - タイトル、説明、背景、制約事項を編集
   - 各フィールドにバリデーションあり

3. **保存**
   - 「保存」ボタンをクリック
   - または`Ctrl+S`（Mac: `Cmd+S`）

4. **キャンセル**
   - 「キャンセル」ボタンをクリック
   - またはモーダル外をクリック
   - または`Esc`キー

#### フィールド

- **タイトル**: 必須、最大100文字
- **説明**: 必須、最大500文字
- **背景**: 必須、最大500文字
- **制約事項**: 任意、最大500文字

### 3. 変更履歴

すべての編集操作は自動的に記録され、履歴として保存されます。

#### 使い方

1. **履歴を表示**
   - 「履歴」ボタンをクリック
   - 履歴パネルが開く

2. **履歴の確認**
   - 変更日時、変更者、変更内容を表示
   - 差分をハイライト表示

3. **ロールバック**（管理者のみ）
   - 履歴エントリを選択
   - 「ロールバック」ボタンをクリック
   - 確認ダイアログで承認

#### 履歴情報

- 変更日時
- 変更者（ユーザーID）
- 変更前の値
- 変更後の値
- 変更されたフィールド

### 4. 競合解決

複数のユーザーが同時に編集した場合の競合を検出し、解決する機能です。

#### 競合検出

- 楽観的ロック（`updatedAt`タイムスタンプ）を使用
- 保存時に競合を検出
- 競合ダイアログを表示

#### 競合解決の選択肢

1. **最新データを取得**
   - 他のユーザーの変更を優先
   - 自分の変更を破棄

2. **変更を破棄**
   - 編集をキャンセル
   - 元の状態に戻る

3. **差分を確認**
   - 自分の変更と他のユーザーの変更を比較
   - どちらを採用するか判断

## API仕様

### 目標更新API

```
PUT /api/goals/:goalId
```

#### リクエストボディ

```json
{
  "title": "目標タイトル",
  "description": "目標説明",
  "deadline": "2025-12-31",
  "background": "背景",
  "constraints": "制約事項",
  "updatedAt": "2025-01-05T12:00:00Z"
}
```

#### レスポンス

**成功（200 OK）**

```json
{
  "success": true,
  "data": {
    "id": "goal-123",
    "title": "目標タイトル",
    "description": "目標説明",
    "deadline": "2025-12-31",
    "background": "背景",
    "constraints": "制約事項",
    "updatedAt": "2025-01-05T12:00:01Z"
  }
}
```

**競合エラー（409 Conflict）**

```json
{
  "success": false,
  "error": "Conflict detected",
  "message": "このデータは他のユーザーによって更新されています",
  "latestData": {
    "id": "goal-123",
    "title": "最新の目標タイトル",
    "updatedAt": "2025-01-05T12:00:00.5Z"
  }
}
```

### サブ目標更新API

```
PUT /api/subgoals/:subGoalId
```

リクエスト・レスポンス形式は目標更新APIと同様です。

### アクション更新API

```
PUT /api/actions/:actionId
```

リクエスト・レスポンス形式は目標更新APIと同様です。

### 変更履歴取得API

```
GET /api/goals/:goalId/history?page=1&limit=10
GET /api/subgoals/:subGoalId/history?page=1&limit=10
GET /api/actions/:actionId/history?page=1&limit=10
```

#### レスポンス

```json
{
  "success": true,
  "data": {
    "entries": [
      {
        "id": "history-123",
        "entityType": "goal",
        "entityId": "goal-123",
        "changedBy": "user-456",
        "changedAt": "2025-01-05T12:00:00Z",
        "changes": {
          "title": {
            "before": "旧タイトル",
            "after": "新タイトル"
          }
        }
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 25,
      "totalPages": 3
    }
  }
}
```

### ロールバックAPI（管理者のみ）

```
POST /api/goals/:goalId/rollback
```

#### リクエストボディ

```json
{
  "historyId": "history-123"
}
```

#### レスポンス

```json
{
  "success": true,
  "data": {
    "id": "goal-123",
    "title": "ロールバック後のタイトル",
    "updatedAt": "2025-01-05T12:00:02Z"
  }
}
```

## セキュリティ

### 入力サニタイゼーション

すべての入力値は以下の処理を経てサニタイズされます：

1. **DOMPurify**による XSS 対策
2. **HTMLエンティティエンコーディング**
3. **危険なタグ・属性の除去**

### 権限チェック

- **フロントエンド**: UI レベルでの権限チェック
- **バックエンド**: API レベルでの厳密な権限チェック
- **ロールバック**: 管理者権限が必要

### 楽観的ロック

- `updatedAt`タイムスタンプによる競合検出
- 競合時は409 Conflictエラーを返す
- ユーザーに競合解決の選択肢を提示

## パフォーマンス最適化

### 楽観的UI更新

- 保存前にUIを即座に更新
- APIレスポンス待機中もスムーズな操作感
- エラー時は自動的にロールバック

### デバウンス処理

- バリデーション: 300ms
- API呼び出し: 500ms
- 不要なリクエストを削減

### メモ化

- React.memoによるコンポーネントの再レンダリング抑制
- useMemoによる計算結果のキャッシュ
- useCallbackによる関数の再生成抑制

## アクセシビリティ

### キーボード操作

- すべての機能がキーボードで操作可能
- Tab/Shift+Tabでのフォーカス移動
- Enter/Escでの保存/キャンセル

### ARIA属性

- `role="dialog"`: モーダルダイアログ
- `aria-label`: 要素の説明
- `aria-describedby`: 詳細説明の関連付け
- `aria-live`: 動的コンテンツの通知

### スクリーンリーダー対応

- 適切なARIA属性の設定
- フォーカス管理
- 状態変更の通知

## トラブルシューティング

### 編集が保存されない

**原因**
- ネットワークエラー
- バリデーションエラー
- 権限不足

**解決方法**
1. ネットワーク接続を確認
2. エラーメッセージを確認
3. 入力値を確認
4. ログインし直す

### 競合エラーが頻発する

**原因**
- 複数ユーザーが同時に編集
- ページを長時間開いたまま

**解決方法**
1. ページをリロード
2. 最新データを取得
3. 編集を再試行

### 履歴が表示されない

**原因**
- 権限不足
- データが存在しない

**解決方法**
1. 権限を確認
2. 編集履歴があるか確認

## 今後の拡張予定

- [ ] リアルタイム同期（WebSocket）
- [ ] オフライン編集対応
- [ ] 変更の一括適用
- [ ] 編集権限の細かい制御
- [ ] 変更通知機能

## 関連ドキュメント

- [API仕様書](../../../docs/api-specification.md)
- [セキュリティガイド](../../../.kiro/steering/8-security-guide.md)
- [アクセシビリティガイド](../../../docs/accessibility-guide.md)
