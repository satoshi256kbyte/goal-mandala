# 要件定義書

## はじめに

この要件定義書は、ユーザーが入力した目標から8つのサブ目標を自動生成するAPIの実装について定義します。2.2.1で実装したBedrock Lambda関数を基盤として、目標入力からマンダラチャート作成の最初のステップとなるサブ目標生成機能を提供します。

## 要件

### 要件1: サブ目標生成エンドポイント

**ユーザーストーリー:** ユーザーとして、目標情報を入力してサブ目標を自動生成したい。そうすることで、目標達成のための具体的な道筋を素早く把握できる。

#### 受入基準

1. WHEN POST /api/ai/generate/subgoals エンドポイントにリクエストを送信する THEN サブ目標生成処理が開始される
2. WHEN リクエストボディに目標情報が含まれる THEN 必須フィールド（title、description、deadline、background）が検証される
3. WHEN 認証トークンが有効である THEN ユーザーIDが抽出され、リクエストに紐付けられる
4. WHEN サブ目標生成が成功する THEN 8個のサブ目標がデータベースに保存される
5. WHEN レスポンスを返す THEN 生成されたサブ目標の配列とメタデータが返される
6. WHEN エラーが発生する THEN 適切なHTTPステータスコードとエラーメッセージが返される

### 要件2: 入力検証機能

**ユーザーストーリー:** システム開発者として、不正な入力データを早期に検出したい。そうすることで、AI生成の失敗を防ぎ、ユーザーに適切なフィードバックを提供できる。

#### 受入基準

1. WHEN 目標タイトルが空である THEN バリデーションエラーが返される
2. WHEN 目標タイトルが200文字を超える THEN バリデーションエラーが返される
3. WHEN 目標説明が空である THEN バリデーションエラーが返される
4. WHEN 目標説明が2000文字を超える THEN バリデーションエラーが返される
5. WHEN 達成期限が過去の日付である THEN バリデーションエラーが返される
6. WHEN 背景情報が1000文字を超える THEN バリデーションエラーが返される
7. WHEN 制約事項が1000文字を超える THEN バリデーションエラーが返される
8. WHEN 必須フィールドが欠けている THEN 具体的なフィールド名を含むエラーメッセージが返される

### 要件3: プロンプト最適化

**ユーザーストーリー:** システム開発者として、高品質なサブ目標を生成したい。そうすることで、ユーザーの目標達成を効果的にサポートできる。

#### 受入基準

1. WHEN プロンプトを生成する THEN 目標のコンテキスト（タイトル、説明、期限、背景、制約）が適切に構造化される
2. WHEN プロンプトを生成する THEN サブ目標の生成条件（8個、具体的、測定可能、重複なし）が明示される
3. WHEN プロンプトを生成する THEN 出力形式（JSON）とスキーマが明確に指定される
4. WHEN ユーザーの業種・職種情報が利用可能である THEN プロンプトにコンテキストとして含まれる
5. WHEN プロンプトを最適化する THEN 不要なトークンが削減され、コストが最小化される
6. WHEN プロンプトを構築する THEN プロンプトインジェクション対策が適用される

### 要件4: レスポンス整形機能

**ユーザーストーリー:** フロントエンド開発者として、一貫性のあるレスポンス形式を受け取りたい。そうすることで、UIでの表示処理が容易になる。

#### 受入基準

1. WHEN サブ目標生成が成功する THEN レスポンスに success: true が含まれる
2. WHEN サブ目標生成が成功する THEN レスポンスに8個のサブ目標配列が含まれる
3. WHEN 各サブ目標を返す THEN id、title、description、background、position フィールドが含まれる
4. WHEN サブ目標のpositionを設定する THEN 0から7の連番が割り当てられる
5. WHEN エラーが発生する THEN レスポンスに success: false とエラー詳細が含まれる
6. WHEN レスポンスを返す THEN 適切なContent-Type（application/json）が設定される
7. WHEN レスポンスを返す THEN CORSヘッダーが適切に設定される

### 要件5: 生成品質評価機能

**ユーザーストーリー:** システム開発者として、生成されたサブ目標の品質を評価したい。そうすることで、低品質な結果を検出し、再生成を促すことができる。

#### 受入基準

1. WHEN サブ目標が生成される THEN 8個のサブ目標が生成されていることが検証される
2. WHEN サブ目標が生成される THEN 各サブ目標のタイトルが30文字以内であることが検証される
3. WHEN サブ目標が生成される THEN 各サブ目標の説明が200文字以内であることが検証される
4. WHEN サブ目標が生成される THEN 各サブ目標の背景が100文字以内であることが検証される
5. WHEN サブ目標のタイトルが重複している THEN 警告ログが記録される
6. WHEN サブ目標の説明が不十分である（50文字未満） THEN 警告ログが記録される
7. WHEN 品質基準を満たさない THEN エラーレスポンスが返され、再試行が促される

### 要件6: データベース統合

**ユーザーストーリー:** システム開発者として、生成されたサブ目標をデータベースに永続化したい。そうすることで、ユーザーが後から確認・編集できる。

#### 受入基準

1. WHEN サブ目標生成が成功する THEN Goalレコードが作成または更新される
2. WHEN サブ目標を保存する THEN 8個のSubGoalレコードがトランザクション内で作成される
3. WHEN データベースエラーが発生する THEN トランザクションがロールバックされる
4. WHEN サブ目標を保存する THEN goalIdとの外部キー関係が正しく設定される
5. WHEN サブ目標を保存する THEN position（0-7）がユニーク制約を満たす
6. WHEN サブ目標を保存する THEN createdAtとupdatedAtが自動設定される
7. WHEN 既存のサブ目標が存在する THEN 既存データを削除してから新規作成される

### 要件7: エラーハンドリングと再試行

**ユーザーストーリー:** ユーザーとして、AI生成が失敗した場合に適切なフィードバックを受け取りたい。そうすることで、問題を理解し、適切に対処できる。

#### 受入基準

1. WHEN Bedrock APIがスロットリングエラーを返す THEN 自動的にリトライが実行される
2. WHEN リトライが3回失敗する THEN ユーザーフレンドリーなエラーメッセージが返される
3. WHEN JSON解析エラーが発生する THEN 「AI生成結果の解析に失敗しました」というメッセージが返される
4. WHEN データベースエラーが発生する THEN 「データの保存に失敗しました」というメッセージが返される
5. WHEN タイムアウトが発生する THEN 「処理時間が長すぎます。もう一度お試しください」というメッセージが返される
6. WHEN エラーが発生する THEN エラー詳細がCloudWatch Logsに記録される
7. WHEN エラーが発生する THEN ユーザーには機密情報を含まないエラーメッセージが返される

### 要件8: パフォーマンスとコスト管理

**ユーザーストーリー:** システム管理者として、API呼び出しのパフォーマンスとコストを管理したい。そうすることで、予算内で安定したサービスを提供できる。

#### 受入基準

1. WHEN サブ目標生成リクエストを処理する THEN 95パーセンタイルで30秒以内に完了する
2. WHEN 同時リクエストが発生する THEN Lambda同時実行数制限（10）が適用される
3. WHEN トークン使用量を記録する THEN CloudWatchカスタムメトリクスに送信される
4. WHEN 推定コストを計算する THEN ログに記録される
5. WHEN 月次コスト上限に近づく THEN アラートが発行される
6. WHEN プロンプトを最適化する THEN 不要なトークンが削減される

### 要件9: セキュリティとアクセス制御

**ユーザーストーリー:** システム管理者として、APIへの不正アクセスを防止したい。そうすることで、システムとユーザーデータを保護できる。

#### 受入基準

1. WHEN APIリクエストを受信する THEN JWT認証トークンが検証される
2. WHEN 認証トークンが無効である THEN 401 Unauthorizedが返される
3. WHEN ユーザーが他人の目標を操作しようとする THEN 403 Forbiddenが返される
4. WHEN レート制限を超える THEN 429 Too Many Requestsが返される
5. WHEN プロンプトインジェクションを検出する THEN リクエストが拒否される
6. WHEN 機密情報をログに記録する THEN マスキングが適用される

### 要件10: 監視とログ

**ユーザーストーリー:** システム管理者として、API呼び出しの状況を監視したい。そうすることで、問題を早期に発見し、対処できる。

#### 受入基準

1. WHEN APIリクエストを処理する THEN 構造化ログがCloudWatch Logsに出力される
2. WHEN ログを出力する THEN requestId、userId、処理時間が含まれる
3. WHEN サブ目標生成が成功する THEN 成功メトリクスがCloudWatchに送信される
4. WHEN サブ目標生成が失敗する THEN 失敗メトリクスとエラー種別がCloudWatchに送信される
5. WHEN 処理時間が閾値を超える THEN アラートが発行される
6. WHEN エラー率が閾値を超える THEN アラートが発行される

## 非機能要件

### パフォーマンス

- API応答時間: 95パーセンタイルで30秒以内
- スループット: 10リクエスト/秒（初期設定）
- データベース接続: 接続プール使用

### 可用性

- API成功率: 99%以上
- 自動リトライによる復旧
- エラー時の適切なフォールバック

### スケーラビリティ

- Lambda同時実行数: 10（初期）→ 100（段階的拡張）
- データベース接続数: 適切な接続プール設定

### セキュリティ

- JWT認証必須
- プロンプトインジェクション対策
- レート制限: 10リクエスト/分/ユーザー
- 入力サニタイゼーション

### 監視

- CloudWatch Logsへの構造化ログ出力
- CloudWatch Metricsへのカスタムメトリクス送信
- エラー率、レスポンス時間、コストの監視
- アラート設定（エラー率、レスポンス時間）

## 制約事項

- Amazon Bedrock Nova Microモデルの利用制限に準拠
- Lambda関数の実行時間制限（最大15分）
- データベース接続数の制限
- 月次コスト予算の制約

## 依存関係

- 2.2.1 Bedrock Lambda関数（完了済み）
- 1.4.2 Prismaスキーマ定義（完了済み）
- 1.3.2 JWT認証ミドルウェア（完了済み）
- AWS SDK for JavaScript v3
- Prismaクライアント
- Zodバリデーションライブラリ

## 成功基準

1. サブ目標生成APIが正常に動作する
2. 全ての受入基準を満たす
3. ユニットテストカバレッジが80%以上
4. 統合テストが全て成功する
5. パフォーマンス要件を満たす
6. セキュリティ要件を満たす
7. ドキュメントが整備される
8. フロントエンドとの統合が完了する

## インターフェース定義

### リクエスト形式

```typescript
POST /api/ai/generate/subgoals
Content-Type: application/json
Authorization: Bearer <JWT_TOKEN>

{
  "goalId": "uuid", // 既存の目標を更新する場合（オプション）
  "title": "TypeScriptのエキスパートになる",
  "description": "6ヶ月でTypeScriptの高度な機能を習得し、実務で活用できるレベルになる",
  "deadline": "2025-12-31T23:59:59Z",
  "background": "フロントエンド開発者として、型安全性の高いコードを書けるようになりたい",
  "constraints": "平日は2時間、週末は4時間の学習時間を確保できる"
}
```

### レスポンス形式（成功）

```typescript
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "data": {
    "goalId": "uuid",
    "subGoals": [
      {
        "id": "uuid",
        "title": "TypeScriptの基礎文法を習得する",
        "description": "型システム、インターフェース、ジェネリクスなどの基本概念を理解し、実践できるようになる",
        "background": "TypeScriptの基礎がなければ、高度な機能を理解することは困難である",
        "position": 0,
        "progress": 0,
        "createdAt": "2025-10-07T10:00:00Z",
        "updatedAt": "2025-10-07T10:00:00Z"
      },
      // ... 残り7個のサブ目標
    ]
  },
  "metadata": {
    "generatedAt": "2025-10-07T10:00:00Z",
    "tokensUsed": 1500,
    "estimatedCost": 0.000225
  }
}
```

### レスポンス形式（エラー）

```typescript
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力データが不正です",
    "details": [
      {
        "field": "title",
        "message": "目標タイトルは必須です"
      }
    ]
  }
}
```
