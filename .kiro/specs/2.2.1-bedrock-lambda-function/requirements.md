# 要件定義書

## はじめに

この要件定義書は、Amazon Bedrockを使用したAI生成機能の基盤となるLambda関数の実装について定義します。目標管理曼荼羅システムにおいて、ユーザーが入力した目標からサブ目標、アクション、タスクを自動生成するための基盤機能を提供します。

## 要件

### 要件1: Bedrock SDK統合

**ユーザーストーリー:** システム開発者として、Amazon Bedrock APIを呼び出せるようにしたい。そうすることで、Nova MicroモデルによるAIテキスト生成が可能になる。

#### 受入基準

1. WHEN Lambda関数が実行される THEN AWS SDK for JavaScript v3のBedrockクライアントが正しく初期化される
2. WHEN Bedrockクライアントを初期化する THEN 適切なリージョン設定（ap-northeast-1）が適用される
3. WHEN Lambda関数がデプロイされる THEN 必要なIAM権限（bedrock:InvokeModel）が付与される
4. WHEN Bedrock APIを呼び出す THEN エラーハンドリングが適切に実装される
5. WHEN 環境変数が設定される THEN モデルIDやリージョンが外部から設定可能である

### 要件2: Nova Microモデル設定

**ユーザーストーリー:** システム開発者として、Nova Microモデルを使用してコスト効率的にテキスト生成を行いたい。そうすることで、運用コストを抑えながら高品質な生成結果が得られる。

#### 受入基準

1. WHEN モデルを指定する THEN Nova Microモデル（amazon.nova-micro-v1:0）が使用される
2. WHEN モデルパラメータを設定する THEN 温度（temperature）、最大トークン数（maxTokens）、トップP（topP）が適切に設定される
3. WHEN 生成リクエストを送信する THEN システムメッセージとユーザーメッセージが正しいフォーマットで送信される
4. WHEN モデルが応答する THEN レスポンスが期待される形式（JSON）で返される
5. WHEN モデル設定を変更する THEN 環境変数またはパラメータで柔軟に調整可能である

### 要件3: プロンプトテンプレート作成

**ユーザーストーリー:** システム開発者として、目的別のプロンプトテンプレートを管理したい。そうすることで、サブ目標生成、アクション生成、タスク生成で一貫性のある高品質な結果が得られる。

#### 受入基準

1. WHEN サブ目標生成を要求する THEN 目標情報を含む専用プロンプトテンプレートが使用される
2. WHEN アクション生成を要求する THEN サブ目標情報を含む専用プロンプトテンプレートが使用される
3. WHEN タスク生成を要求する THEN アクション情報を含む専用プロンプトテンプレートが使用される
4. WHEN プロンプトを構築する THEN ユーザー入力（背景、制約事項）が適切にエスケープされる
5. WHEN プロンプトテンプレートを管理する THEN バージョン管理とテストが容易な構造である
6. WHEN プロンプトを生成する THEN 出力形式（JSON）が明確に指定される
7. WHEN プロンプトに制約を含める THEN 生成数（8個）や文字数制限が明示される

### 要件4: レスポンス解析機能

**ユーザーストーリー:** システム開発者として、Bedrockからのレスポンスを構造化データに変換したい。そうすることで、データベースへの保存やフロントエンドでの表示が容易になる。

#### 受入基準

1. WHEN Bedrockレスポンスを受信する THEN JSON形式のテキストが抽出される
2. WHEN JSONテキストを解析する THEN 有効なJavaScriptオブジェクトに変換される
3. WHEN 解析結果を検証する THEN 必須フィールド（title、description等）の存在が確認される
4. WHEN 生成数を検証する THEN サブ目標・アクションが8個生成されていることが確認される
5. WHEN 不正なレスポンスを受信する THEN 適切なエラーメッセージが返される
6. WHEN レスポンスにマークダウンコードブロックが含まれる THEN 正しくJSON部分が抽出される
7. WHEN 型安全性を確保する THEN TypeScriptの型定義が適用される

### 要件5: エラーハンドリング

**ユーザーストーリー:** システム開発者として、AI生成処理の失敗を適切に処理したい。そうすることで、システムの安定性が向上し、ユーザーに適切なフィードバックを提供できる。

#### 受入基準

1. WHEN Bedrock APIがエラーを返す THEN エラーの種類（スロットリング、認証エラー等）が識別される
2. WHEN スロットリングエラーが発生する THEN 指数バックオフでリトライが実行される
3. WHEN リトライ可能なエラーが発生する THEN 最大3回までリトライが試行される
4. WHEN リトライ不可能なエラーが発生する THEN 即座にエラーレスポンスが返される
5. WHEN JSON解析エラーが発生する THEN 詳細なエラー情報がログに記録される
6. WHEN タイムアウトが発生する THEN 適切なタイムアウトエラーが返される
7. WHEN エラーが発生する THEN ユーザーフレンドリーなエラーメッセージが生成される
8. WHEN エラーをログに記録する THEN CloudWatch Logsに構造化ログが出力される

### 要件6: パフォーマンスとコスト最適化

**ユーザーストーリー:** システム開発者として、Lambda関数のパフォーマンスとコストを最適化したい。そうすることで、レスポンス時間を短縮し、運用コストを削減できる。

#### 受入基準

1. WHEN Lambda関数を初期化する THEN Bedrockクライアントが関数スコープで再利用される
2. WHEN 複数リクエストを処理する THEN コネクションプーリングが有効に機能する
3. WHEN Lambda関数を設定する THEN 適切なメモリサイズ（512MB-1024MB）が設定される
4. WHEN Lambda関数を設定する THEN タイムアウトが適切に設定される（最大15分）
5. WHEN プロンプトを最適化する THEN 不要なトークンが削減される
6. WHEN レスポンスを処理する THEN 必要最小限のデータのみが返される

### 要件7: セキュリティ

**ユーザーストーリー:** システム開発者として、AI生成機能のセキュリティを確保したい。そうすることで、機密情報の漏洩やプロンプトインジェクション攻撃を防止できる。

#### 受入基準

1. WHEN ユーザー入力を処理する THEN プロンプトインジェクション対策が実装される
2. WHEN 機密情報を扱う THEN ログに機密情報が出力されない
3. WHEN IAMロールを設定する THEN 最小権限の原則が適用される
4. WHEN 環境変数を使用する THEN 機密情報がSecrets Managerから取得される
5. WHEN APIを呼び出す THEN リクエストレート制限が実装される
6. WHEN 入力を検証する THEN 文字数制限やフォーマット検証が実装される

### 要件8: テスト容易性

**ユーザーストーリー:** システム開発者として、Lambda関数を容易にテストしたい。そうすることで、品質を保証し、リグレッションを防止できる。

#### 受入基準

1. WHEN ユニットテストを作成する THEN Bedrockクライアントがモック可能である
2. WHEN 統合テストを実行する THEN ローカル環境でテスト可能である
3. WHEN テストデータを準備する THEN サンプルプロンプトとレスポンスが用意される
4. WHEN テストカバレッジを測定する THEN 80%以上のカバレッジが達成される
5. WHEN エラーケースをテストする THEN 各種エラーシナリオがカバーされる

## 非機能要件

### パフォーマンス

- Lambda関数のコールドスタート時間: 3秒以内
- Bedrock API呼び出しのレスポンス時間: 10秒以内（95パーセンタイル）
- 同時実行数: 最大10（初期設定）

### 可用性

- Lambda関数の成功率: 99%以上
- リトライ機能による自動復旧

### スケーラビリティ

- 段階的な同時実行数の増加に対応
- オートスケーリング設定

### 監視

- CloudWatch Logsへの構造化ログ出力
- CloudWatch Metricsへのカスタムメトリクス送信
- エラー率、レスポンス時間、コストの監視

## 制約事項

- Amazon Bedrock Nova Microモデルの利用制限に準拠
- Lambda関数の実行時間制限（最大15分）
- Bedrockのリージョン制限（ap-northeast-1）
- コスト制約（月額予算内での運用）

## 依存関係

- AWS SDK for JavaScript v3 (@aws-sdk/client-bedrock-runtime)
- TypeScript型定義
- Prismaクライアント（データベースアクセス用）
- 既存の認証ミドルウェア

## 成功基準

1. Bedrock APIを使用したテキスト生成が正常に動作する
2. 全ての受入基準を満たす
3. ユニットテストカバレッジが80%以上
4. 統合テストが全て成功する
5. パフォーマンス要件を満たす
6. セキュリティ要件を満たす
7. ドキュメントが整備される
