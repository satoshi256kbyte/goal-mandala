# 要件定義書

## 概要

AWS CDKを使用してVPC・ネットワーク構成を構築し、セキュアで高可用性なネットワーク基盤を提供する機能を実装します。

## 要件

### 要件1

**ユーザーストーリー:** インフラ管理者として、セキュアで高可用性なVPCネットワーク基盤を構築したい。そうすることで、アプリケーションが安全かつ安定して動作する環境を提供できる。

#### 受入基準

1. WHEN VPCスタックをデプロイする THEN 10.0.0.0/16のCIDRブロックでVPCが作成される SHALL
2. WHEN VPCを作成する THEN 2つのアベイラビリティゾーンにまたがってサブネットが配置される SHALL
3. WHEN サブネットを作成する THEN パブリック、プライベート、データベース用の3種類のサブネットが作成される SHALL
4. WHEN パブリックサブネットを作成する THEN インターネットゲートウェイ経由でインターネットアクセスが可能になる SHALL
5. WHEN プライベートサブネットを作成する THEN NATゲートウェイ経由でアウトバウンド通信が可能になる SHALL

### 要件2

**ユーザーストーリー:** インフラ管理者として、適切なセキュリティグループを設定したい。そうすることで、必要最小限の通信のみを許可し、セキュリティを確保できる。

#### 受入基準

1. WHEN データベース用セキュリティグループを作成する THEN Lambda関数からのPostgreSQL接続（ポート5432）のみを許可する SHALL
2. WHEN Lambda用セキュリティグループを作成する THEN 外部APIへのアウトバウンド通信を許可する SHALL
3. WHEN ALB用セキュリティグループを作成する THEN HTTP（ポート80）とHTTPS（ポート443）のインバウンド通信を許可する SHALL
4. WHEN セキュリティグループを作成する THEN 不要な通信は全て拒否される SHALL
5. WHEN セキュリティグループ間の通信を設定する THEN 最小権限の原則に従って設定される SHALL

### 要件3

**ユーザーストーリー:** インフラ管理者として、ネットワークトラフィックを監視したい。そうすることで、セキュリティインシデントの検知と分析が可能になる。

#### 受入基準

1. WHEN VPCフローログを設定する THEN 全てのネットワークトラフィックがCloudWatch Logsに記録される SHALL
2. WHEN フローログを設定する THEN ログの保持期間が1ヶ月に設定される SHALL
3. WHEN フローログを設定する THEN 適切なIAMロールが自動作成される SHALL
4. WHEN ログを記録する THEN 承認されたトラフィックと拒否されたトラフィックの両方が記録される SHALL

### 要件4

**ユーザーストーリー:** インフラ管理者として、環境別にネットワーク構成を最適化したい。そうすることで、コストと可用性のバランスを取ることができる。

#### 受入基準

1. WHEN 本番環境をデプロイする THEN 高可用性のため2つのNATゲートウェイが作成される SHALL
2. WHEN 開発環境をデプロイする THEN コスト最適化のため1つのNATゲートウェイのみが作成される SHALL
3. WHEN 本番環境またはステージング環境をデプロイする THEN VPCエンドポイントが作成される SHALL
4. WHEN 開発環境をデプロイする THEN コスト最適化のためVPCエンドポイントは作成されない SHALL

### 要件5

**ユーザーストーリー:** インフラ管理者として、VPCエンドポイントを設定したい。そうすることで、AWSサービスへの通信をプライベートネットワーク内で完結させ、セキュリティと性能を向上させることができる。

#### 受入基準

1. WHEN VPCエンドポイントを作成する THEN S3とDynamoDB用のGatewayエンドポイントが作成される SHALL
2. WHEN VPCエンドポイントを作成する THEN Secrets Manager、CloudWatch Logs、Bedrock用のInterfaceエンドポイントが作成される SHALL
3. WHEN Interfaceエンドポイントを作成する THEN 適切なセキュリティグループが関連付けられる SHALL
4. WHEN VPCエンドポイントを作成する THEN プライベートサブネットに配置される SHALL

### 要件6

**ユーザーストーリー:** 開発者として、VPCリソースの情報を他のスタックから参照したい。そうすることで、データベースやAPIスタックでVPCリソースを利用できる。

#### 受入基準

1. WHEN VPCスタックをデプロイする THEN VPC IDがCloudFormation出力として公開される SHALL
2. WHEN VPCスタックをデプロイする THEN サブネットIDがCloudFormation出力として公開される SHALL
3. WHEN VPCスタックをデプロイする THEN セキュリティグループIDがCloudFormation出力として公開される SHALL
4. WHEN 出力を作成する THEN 他のスタックからインポート可能な形式で出力される SHALL
5. WHEN 出力を作成する THEN 適切な説明が付与される SHALL

### 要件7

**ユーザーストーリー:** インフラ管理者として、適切なタグ管理を行いたい。そうすることで、リソースの管理と課金の追跡が容易になる。

#### 受入基準

1. WHEN VPCリソースを作成する THEN 環境名、プロジェクト名のタグが自動付与される SHALL
2. WHEN セキュリティグループを作成する THEN 用途を示すNameタグが付与される SHALL
3. WHEN タグを設定する THEN 設定ファイルで定義されたカスタムタグが適用される SHALL
4. WHEN リソースを作成する THEN 一貫したタグ命名規則が適用される SHALL
