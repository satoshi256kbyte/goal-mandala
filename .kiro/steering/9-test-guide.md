# テストガイド

## テスト戦略

### テストピラミッド

テストは以下の3層構造で実装します：  

- **E2Eテスト（少数）**: Playwrightによる主要ユーザーフローのテスト
- **統合テスト（中程度）**: API + データベースの結合テスト
- **ユニットテスト（多数）**: Jest + React Testing Libraryによる単体テスト

### テスト方針

- **ユニットテスト**: 80%以上のカバレッジ目標
- **統合テスト**: API + データベースの結合テスト
- **E2Eテスト**: 主要なユーザーフローをカバー
- **パフォーマンステスト**: レスポンス時間とスループット
- **セキュリティテスト**: 認証・認可の検証

**テスト実行時は、必ずバックグラウンドでタイムアウトを設定して実行してください。**
**どちらかが欠けるとループや何らかの入力待ちが発生した時に、無限にテストが動き続けてしまいます。**
**また、テスト実行は、極力テスト実行の進捗をリアルタイム表示する形で実行してください。どこかで止まる場合にリアルタイム表示がある方が特定しやすいです。**

## ユニットテスト

### バックエンドテスト（Jest）

#### テスト設定

Jest設定でTypeScript環境とカバレッジ要件を定義します。  

#### 設定内容

- TypeScript対応
- カバレッジ閾値80%
- テストファイルパターン
- セットアップファイル

#### AIサービステスト

- サブ目標生成機能（8個生成の検証）
- アクション生成機能
- タスク生成機能
- エラーハンドリング
- APIレスポンスの形式検証

#### データベースサービステスト

- CRUD操作の正常動作
- 外部キー制約の検証
- バリデーションエラーの処理
- トランザクション処理

### フロントエンドテスト（React Testing Library）

#### テスト実行戦略

フロントエンドでは、開発フローに応じて最適なテストコマンドを使い分けます：

**テストコマンド一覧**:

```bash
# 高速ユニットテスト（デフォルト、推奨）
pnpm --filter @goal-mandala/frontend test

# ユニットテストのみ実行
pnpm --filter @goal-mandala/frontend test:unit

# 統合テストのみ実行
pnpm --filter @goal-mandala/frontend test:integration

# 最速テスト（開発中の確認用）
pnpm --filter @goal-mandala/frontend test:fast

# カバレッジ付きテスト（CI/CD用）
pnpm --filter @goal-mandala/frontend test:coverage
```

**パフォーマンス目標**:

| テストタイプ | 目標時間 | 用途 |
|------------|---------|------|
| test:fast | 15秒以内 | 開発中の高速フィードバック |
| test:unit | 30秒以内 | コミット前の品質確認 |
| test:integration | 45秒以内 | 統合テスト実行 |
| test:coverage | 60秒以内 | カバレッジレポート生成 |

**開発フローでの使い分け**:

1. **開発中（頻繁な実行）**: `test:fast`
   - カバレッジ計算なし
   - テスト分離なし
   - 最速でフィードバック

2. **コミット前（品質確認）**: `test:unit`
   - ユニットテストのみ
   - カバレッジ計算なし
   - 適度な実行時間

3. **PR作成前（完全チェック）**: `test:coverage`
   - 全テスト実行
   - カバレッジレポート生成
   - 品質ゲート確認

#### コンポーネントテスト

React コンポーネントのテストでは以下を検証します：  

#### テスト内容

- コンポーネントの正常レンダリング
- プロパティの正しい表示
- ユーザーインタラクション
- 状態変更の検証

#### カスタムフックテスト

- フックの初期状態
- 状態更新の動作
- 副作用の実行
- エラーハンドリング

## 統合テスト

### APIテスト

- エンドポイントの正常動作
- 認証・認可の検証
- リクエスト・レスポンスの形式
- エラーレスポンスの検証

### データベーステスト

- マンダラ構造の完全作成
- カスケード削除の動作
- 制約違反の検証
- パフォーマンスの確認

## E2Eテスト（Playwright）

- 複数ブラウザ対応（Chrome、Firefox、Safari）
- 並列実行設定
- スクリーンショット・動画記録
- リトライ設定

### 認証フローテスト

- ログイン成功パターン
- ログイン失敗パターン
- サインアップフロー
- パスワードリセット

### マンダラ作成フローテスト

- 目標入力からマンダラ完成まで
- AI処理の待機
- サブ目標・アクションの編集
- 活動開始の確認

### タスク管理フローテスト

- タスク状態の更新
- 進捗の反映
- 気分選択機能
- フィルター・検索機能

## パフォーマンステスト

### 負荷テスト

- 同時接続数の上限
- レスポンス時間の測定
- スループットの測定
- リソース使用量の監視

### パフォーマンス監視

- API応答時間の記録
- 遅いリクエストの検出
- CloudWatchメトリクス送信
- アラート設定

## テスト実行

### ローカル開発でのテスト実行

**高速フィードバックループ**:

```
開発中 → test:fast (10-20秒)
  ↓
コミット前 → test:unit (30-40秒)
  ↓
PR作成 → test:coverage + test:integration (60-90秒)
  ↓
マージ前 → test:e2e (2-3分)
```

**テスト実行のベストプラクティス**:

1. **開発中は高速テストを頻繁に実行**
   - `test:fast` で即座にフィードバック
   - カバレッジ計算をスキップして高速化

2. **コミット前にユニットテストを確認**
   - `test:unit` で品質を担保
   - 統合テストは除外して実行時間を短縮

3. **PR作成前に完全チェック**
   - `test:coverage` でカバレッジ確認
   - `test:integration` で統合テスト実行

4. **タイムアウト設定を活用**
   - 無限ループやハングを防止
   - CI/CD環境でも安全に実行

### CI/CDでのテスト実行

- プルリクエスト時のユニットテスト
- マージ時のE2Eテスト
- カバレッジレポートの生成
- テスト結果の通知

**CI/CD最適化**:

- 並列実行数の最適化（maxConcurrency: 10）
- タイムアウト設定の適切な調整
- レポート形式の最適化（basic reporter）
- キャッシュ戦略の活用

## テストデータ管理

### フィクスチャ

#### データ種類

- ユーザーデータ
- 目標データ
- サブ目標データ
- アクションデータ
- タスクデータ

### テストデータベース

#### 管理内容

- テストユーザーの作成
- テストデータの投入
- テスト後のクリーンアップ
- データの分離

## 品質ゲート

### カバレッジ要件

以下のカバレッジ要件を設定します：  

- **ユニットテスト**: 80%以上
- **統合テスト**: 主要APIエンドポイント100%
- **E2Eテスト**: 主要ユーザーフロー100%

### パフォーマンス要件

以下のパフォーマンス要件を設定します：  

- **API応答時間**: 95%ile < 2秒
- **ページロード時間**: < 3秒
- **AI生成時間**: < 30秒

### テスト実行パフォーマンス要件

フロントエンドテストの実行時間目標：

| テストタイプ | 目標時間 | 現在の実装 |
|------------|---------|-----------|
| test:fast | 15秒以内 | カバレッジなし、分離なし |
| test:unit | 30秒以内 | ユニットテストのみ |
| test:integration | 45秒以内 | 統合テストのみ |
| test:coverage | 60秒以内 | カバレッジ付き全テスト |

**最適化手法**:

1. **カバレッジ計算の制御**
   - デフォルトでカバレッジ計算を無効化
   - 必要な時のみ `test:coverage` で実行

2. **並列実行の最適化**
   - maxConcurrency: 10（5から増加）
   - CPU数に応じた並列実行

3. **テスト分離の制御**
   - `test:fast` では分離を無効化（isolate: false）
   - 高速実行を優先

4. **タイムアウト設定の最適化**
   - testTimeout: 10000ms（5秒から増加）
   - hookTimeout: 5000ms（3秒から増加）
   - teardownTimeout: 3000ms（2秒から増加）

5. **統合テストの分離**
   - ユニットテストと統合テストを分離
   - 必要に応じて個別実行可能

### 品質チェック

以下の品質チェックを実行します：  

- **全テスト実行**: pnpm test:all
- **静的解析**: pnpm lint
- **型チェック**: pnpm type-check
- **カバレッジ確認**: pnpm test:coverage
- **パフォーマンステスト**: pnpm test:performance

## テスト環境管理

### 環境分離

テスト環境は以下のように分離します：  

- **ユニットテスト**: インメモリデータベース
- **統合テスト**: 専用テストデータベース
- **E2Eテスト**: ステージング環境
- **パフォーマンステスト**: 本番相当環境

### データクリーンアップ

テスト実行後は以下のクリーンアップを実行します：  

- テストデータの削除
- データベース状態のリセット
- キャッシュのクリア
- 一時ファイルの削除
