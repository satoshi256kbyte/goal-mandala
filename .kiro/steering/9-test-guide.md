# テストガイド

## テスト戦略

### テストピラミッド

テストは以下の3層構造で実装します：

- **E2Eテスト（少数）**: Playwrightによる主要ユーザーフローのテスト
- **統合テスト（中程度）**: API + データベースの結合テスト
- **ユニットテスト（多数）**: Jest + React Testing Libraryによる単体テスト

### テスト方針

- **ユニットテスト**: 80%以上のカバレッジ目標
- **統合テスト**: API + データベースの結合テスト
- **E2Eテスト**: 主要なユーザーフローをカバー
- **パフォーマンステスト**: レスポンス時間とスループット
- **セキュリティテスト**: 認証・認可の検証

## ユニットテスト

### バックエンドテスト（Jest）

#### テスト設定

Jest設定でTypeScript環境とカバレッジ要件を定義します。

#### 設定内容

- TypeScript対応
- カバレッジ閾値80%
- テストファイルパターン
- セットアップファイル

#### AIサービステスト

- サブ目標生成機能（8個生成の検証）
- アクション生成機能
- タスク生成機能
- エラーハンドリング
- APIレスポンスの形式検証

#### データベースサービステスト

- CRUD操作の正常動作
- 外部キー制約の検証
- バリデーションエラーの処理
- トランザクション処理

### フロントエンドテスト（React Testing Library）

#### コンポーネントテスト

React コンポーネントのテストでは以下を検証します：

#### テスト内容

- コンポーネントの正常レンダリング
- プロパティの正しい表示
- ユーザーインタラクション
- 状態変更の検証

#### カスタムフックテスト

- フックの初期状態
- 状態更新の動作
- 副作用の実行
- エラーハンドリング

## 統合テスト

### APIテスト

- エンドポイントの正常動作
- 認証・認可の検証
- リクエスト・レスポンスの形式
- エラーレスポンスの検証

### データベーステスト

- マンダラ構造の完全作成
- カスケード削除の動作
- 制約違反の検証
- パフォーマンスの確認

## E2Eテスト（Playwright）

- 複数ブラウザ対応（Chrome、Firefox、Safari）
- 並列実行設定
- スクリーンショット・動画記録
- リトライ設定

### 認証フローテスト

- ログイン成功パターン
- ログイン失敗パターン
- サインアップフロー
- パスワードリセット

### マンダラ作成フローテスト

- 目標入力からマンダラ完成まで
- AI処理の待機
- サブ目標・アクションの編集
- 活動開始の確認

### タスク管理フローテスト

- タスク状態の更新
- 進捗の反映
- 気分選択機能
- フィルター・検索機能

## パフォーマンステスト

### 負荷テスト

- 同時接続数の上限
- レスポンス時間の測定
- スループットの測定
- リソース使用量の監視

### パフォーマンス監視

- API応答時間の記録
- 遅いリクエストの検出
- CloudWatchメトリクス送信
- アラート設定

## テスト実行

### CI/CDでのテスト実行

- プルリクエスト時のユニットテスト
- マージ時のE2Eテスト
- カバレッジレポートの生成
- テスト結果の通知

## テストデータ管理

### フィクスチャ

#### データ種類

- ユーザーデータ
- 目標データ
- サブ目標データ
- アクションデータ
- タスクデータ

### テストデータベース

#### 管理内容

- テストユーザーの作成
- テストデータの投入
- テスト後のクリーンアップ
- データの分離

## 品質ゲート

### カバレッジ要件

以下のカバレッジ要件を設定します：

- **ユニットテスト**: 80%以上
- **統合テスト**: 主要APIエンドポイント100%
- **E2Eテスト**: 主要ユーザーフロー100%

### パフォーマンス要件

以下のパフォーマンス要件を設定します：

- **API応答時間**: 95%ile < 2秒
- **ページロード時間**: < 3秒
- **AI生成時間**: < 30秒

### 品質チェック

以下の品質チェックを実行します：

- **全テスト実行**: pnpm test:all
- **静的解析**: pnpm lint
- **型チェック**: pnpm type-check
- **カバレッジ確認**: pnpm test:coverage
- **パフォーマンステスト**: pnpm test:performance

## テスト環境管理

### 環境分離

テスト環境は以下のように分離します：

- **ユニットテスト**: インメモリデータベース
- **統合テスト**: 専用テストデータベース
- **E2Eテスト**: ステージング環境
- **パフォーマンステスト**: 本番相当環境

### データクリーンアップ

テスト実行後は以下のクリーンアップを実行します：

- テストデータの削除
- データベース状態のリセット
- キャッシュのクリア
- 一時ファイルの削除
