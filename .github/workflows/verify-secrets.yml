name: Verify GitHub Secrets

on:
  workflow_dispatch:
  schedule:
    # Run every Monday at 9:00 AM JST (00:00 UTC)
    - cron: "0 0 * * 1"

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify AWS Secrets
        run: |
          echo "üîç Verifying AWS Secrets..."

          # Check AWS_ACCESS_KEY_ID
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "‚ùå AWS_ACCESS_KEY_ID is not set"
            exit 1
          else
            echo "‚úÖ AWS_ACCESS_KEY_ID is set"
          fi

          # Check AWS_SECRET_ACCESS_KEY
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "‚ùå AWS_SECRET_ACCESS_KEY is not set"
            exit 1
          else
            echo "‚úÖ AWS_SECRET_ACCESS_KEY is set"
          fi

      - name: Verify AWS Variables
        run: |
          echo "üîç Verifying AWS Variables..."

          # Check AWS_REGION
          if [ -z "${{ vars.AWS_REGION }}" ]; then
            echo "‚ùå AWS_REGION is not set"
            exit 1
          else
            echo "‚úÖ AWS_REGION is set: ${{ vars.AWS_REGION }}"
          fi

          # Check AWS_ACCOUNT_ID
          if [ -z "${{ vars.AWS_ACCOUNT_ID }}" ]; then
            echo "‚ùå AWS_ACCOUNT_ID is not set"
            exit 1
          else
            echo "‚úÖ AWS_ACCOUNT_ID is set: ${{ vars.AWS_ACCOUNT_ID }}"
          fi

      - name: Verify Deployment Secrets
        run: |
          echo "üîç Verifying Deployment Secrets..."

          # Check S3_BUCKET_NAME
          if [ -z "${{ secrets.S3_BUCKET_NAME }}" ]; then
            echo "‚ö†Ô∏è S3_BUCKET_NAME is not set (required after CDK deployment)"
          else
            echo "‚úÖ S3_BUCKET_NAME is set"
          fi

          # Check CLOUDFRONT_DISTRIBUTION_ID
          if [ -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            echo "‚ö†Ô∏è CLOUDFRONT_DISTRIBUTION_ID is not set (required after CDK deployment)"
          else
            echo "‚úÖ CLOUDFRONT_DISTRIBUTION_ID is set"
          fi

          # Check API_ENDPOINT
          if [ -z "${{ secrets.API_ENDPOINT }}" ]; then
            echo "‚ö†Ô∏è API_ENDPOINT is not set (required after CDK deployment)"
          else
            echo "‚úÖ API_ENDPOINT is set"
          fi

      - name: Verify Optional Secrets
        run: |
          echo "üîç Verifying Optional Secrets..."

          # Check SLACK_WEBHOOK_URL
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "‚ÑπÔ∏è SLACK_WEBHOOK_URL is not set (optional)"
          else
            echo "‚úÖ SLACK_WEBHOOK_URL is set"
          fi

      - name: Test AWS Authentication
        run: |
          echo "üîç Testing AWS Authentication..."

          # Configure AWS credentials
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          export AWS_REGION="${{ vars.AWS_REGION }}"

          # Install AWS CLI
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install

          # Test AWS authentication
          if aws sts get-caller-identity > /dev/null 2>&1; then
            echo "‚úÖ AWS authentication successful"
            aws sts get-caller-identity
          else
            echo "‚ùå AWS authentication failed"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "üìä Verification Summary"
          echo "======================="
          echo ""
          echo "Required Secrets:"
          echo "  - AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID != '' && '‚úÖ' || '‚ùå' }}"
          echo "  - AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY != '' && '‚úÖ' || '‚ùå' }}"
          echo ""
          echo "Required Variables:"
          echo "  - AWS_REGION: ${{ vars.AWS_REGION != '' && '‚úÖ' || '‚ùå' }}"
          echo "  - AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID != '' && '‚úÖ' || '‚ùå' }}"
          echo ""
          echo "Deployment Secrets (required after CDK deployment):"
          echo "  - S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME != '' && '‚úÖ' || '‚ö†Ô∏è' }}"
          echo "  - CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID != '' && '‚úÖ' || '‚ö†Ô∏è' }}"
          echo "  - API_ENDPOINT: ${{ secrets.API_ENDPOINT != '' && '‚úÖ' || '‚ö†Ô∏è' }}"
          echo ""
          echo "Optional Secrets:"
          echo "  - SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL != '' && '‚úÖ' || '‚ÑπÔ∏è' }}"
          echo ""
          echo "Next Steps:"
          echo "  1. If any required secrets are missing, follow the setup guide:"
          echo "     .kiro/specs/4.4-production-verification/temp/github-secrets-setup-guide.md"
          echo "  2. If deployment secrets are missing, deploy CDK stacks first:"
          echo "     cd packages/infrastructure && pnpm cdk deploy --all --context environment=prod"
          echo "  3. After all secrets are set, proceed to deploy workflow testing"
